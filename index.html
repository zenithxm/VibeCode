
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://code.jquery.com; 
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; 
        font-src 'self' https://cdnjs.cloudflare.com; 
        connect-src 'self' https://api.dropboxapi.com https://content.dropboxapi.com;
        img-src 'self' data:;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'none';">

    <title>Saving Book</title>
    <!-- External libraries are kept as they are essential for existing JS functionality -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <style>
        /* ==========================================================================
           0. ROOT & CORE SETUP
           ========================================================================== */
        :root {
            --primary: #2a3d93;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4ade80;
            --warning: #facc15;
            --danger: #f87171;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --white: #ffffff;

            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --spacing: 5px;

            --table-row-even: #f8f9ff;
            --table-row-odd: #ffffff;
            --table-row-hover: #e0e6f8;
            
            --overlay-bg: rgba(0, 0, 0, 0.6);
            --loader-overlay-bg: rgba(33, 37, 41, 0.7);
            --text-shadow-color: #2a3d93;
            --form-input-bg: #ffffff;
            --btn-secondary-hover-bg: #d1d5db;
            --btn-dropbox-bg: #0061ff;
            --btn-dropbox-hover-bg: #0050d0;

            --sortable-placeholder-bg: var(--table-row-hover);
            --sortable-helper-bg: var(--secondary);
            --child-row-details-bg: var(--table-row-even);
            --child-row-details-border: var(--primary);
            --summary-details-total-bg: var(--light-gray);
        }

        body.dark-theme {
            --primary: #2563eb;       /* Vibrant Blue: The main interactive color for buttons, etc. */
            --secondary: #1d4ed8;     /* Darker Blue: Used for headers to create hierarchy. */
            --accent: #4f46e5;        /* Rich Indigo: A harmonious accent for highlights and borders. */
            --light: #161a2b;
            --dark: #e0e0e0;
            --light-gray: #242942;
            --gray: #a0a0a0;
            
            --success: #16a34a; /* Deep Forest Green - WCAG AA compliant */
            --danger: #b91c1c;  /* Rich Crimson - WCAG AA compliant */
            --warning: #d97706; /* Deep Amber - WCAG AA compliant */

            --table-row-even: var(--light-gray); /* #242942 - A subtle blue-gray for stripes */
            --table-row-odd: var(--light);      /* #161a2b - Seamlessly matches the page background */
            --table-row-hover: #102e70;   /* #2d3748 - Uses the main brand color for clear feedback */

            --form-input-bg: var(--light);
            --form-input-border: #3a3a4c;
            --btn-secondary-hover-bg: #4a4a6a;
            
            --sortable-placeholder-bg: #3a3a4c;
            --child-row-details-bg: #0c0f1a;
            --child-row-details-border: var(--accent);
            --summary-details-total-bg: var(--primary);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html,
        body {
            height: 100vh;
            overflow: hidden;
            background-color: var(--light);
            color: var(--dark);
        }

        /* ==========================================================================
           1. CORE LAYOUT
           ========================================================================== */
        body {
            display: flex;
            padding: var(--spacing);
            gap: var(--spacing);
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        main {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
        }

        .page-content {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }

        .page-content.active {
            display: flex;
        }

        /* ==========================================================================
           2. COMPONENTS
           ========================================================================== */
        
        /* --- 2.1 Card --- */
        .card {
            background: var(--light);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: var(--spacing);
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
            gap: var(--spacing);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing);
            border-bottom: 1px solid var(--light-gray);
            flex-shrink: 0;
        }
        
        .card-header h2 {
            font-size: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-header-actions {
            display: flex;
            gap: var(--spacing);
        }

        /* --- 2.2 Sidebar --- */
        .sidebar {
            width: 260px;
            background: var(--light);
            display: flex;
            flex-direction: column;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: width 0.3s ease;
            flex-shrink: 0;
            padding: var(--spacing);
            gap: calc(var(--spacing) * 2);
            cursor: pointer;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar > * {
            cursor: default;
        }

        .sidebar-header {
            padding: var(--spacing);
            border-bottom: 1px solid var(--light-gray);
        }
        
        .sidebar.collapsed .sync-all-btn span {
            display: none;
        }

        .sidebar.collapsed .sync-all-btn {
            justify-content: center;
        }

        .sidebar-menu {
            flex-grow: 1;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: var(--spacing);
        }

        .menu-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--dark);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
            border-radius: var(--border-radius);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .menu-item i.fa-fw {
            width: 1.25em;
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }

        .menu-item:hover {
            background: var(--light-gray);
            color: var(--primary);
        }

        .menu-item.active {
            background: var(--primary);
            color: var(--white);
            font-weight: 600;
        }

        .menu-item.active:hover {
            color: var(--white);
        }

        .sidebar.collapsed .menu-item span {
            display: none;
        }

        .sidebar.collapsed .menu-item {
            justify-content: center;
            padding: 12px;
            position: relative;
            overflow: visible;
        }

        .sidebar.collapsed .menu-item::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 75px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--dark);
            color: var(--light);
            padding: 6px 10px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            z-index: 100;
            box-shadow: var(--box-shadow);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .sidebar.collapsed .menu-item:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-footer {
            display: flex;
            flex-direction: column;
            gap: var(--spacing);
            padding-top: var(--spacing);
            border-top: 1px solid var(--light-gray);
            flex-shrink: 0;
        }

        .sidebar-footer .sidebar-menu {
            flex-grow: 0;
        }

        #sidebar-toggle-btn {
            background: transparent;
        }
        
        .status-item {
            padding: 8px 15px;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            color: var(--dark);
            gap: 15px;
            font-weight: 500;
        }

        .status-text-wrapper {
            display: flex;
            flex-direction: column;
        }

        .status-value {
            color: var(--gray);
            font-weight: normal;
        }

        .status-connected .status-icon { color: var(--success); }
        .status-disconnected .status-icon { color: var(--danger); }

        .sidebar.collapsed .status-text-wrapper {
            display: none;
        }

        /* --- 2.3 Tabs --- */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--light-gray);
            flex-shrink: 0;
        }

        .tab {
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab:hover:not(.active) {
            color: var(--dark);
            background: var(--light-gray);
        }

        .tab-content {
            display: none;
            flex-grow: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .tab-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--spacing);
            background: var(--table-row-even);
            border-radius: var(--border-radius);
        }

        /* --- 2.4 Buttons --- */
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--secondary); }
        .btn-secondary { background: var(--light-gray); color: var(--dark); }
        .btn-secondary:hover { background: var(--btn-secondary-hover-bg); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-warning { background: var(--warning); color: var(--dark); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-dropbox { background: var(--btn-dropbox-bg); color: var(--white); }
        .btn-dropbox:hover { background: var(--btn-dropbox-hover-bg); }

        .btn-small { padding: 5px 8px; font-size: 0.8rem; }

        .sync-all-btn {
            width: 100%;
            justify-content: flex-start;
            font-size: 1rem;
            padding: 12px;
        }

        /* --- 2.5 Tables --- */
        /* Generic Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto; 
        }

        th, td {
            padding: 5px 8px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background-color: var(--light-gray);
            color: var(--dark);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        body.dark-theme th {
            background-color: var(--primary);
            color: var(--white);
        }

        tr:nth-child(even) { background-color: var(--table-row-even); }
        tr:nth-child(odd) { background-color: var(--table-row-odd); }
        tr:hover { background-color: var(--table-row-hover); }

        .table-container {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: auto;
            border-radius: var(--border-radius);
        }

        /* Responsive Table Styles (Shared) */
        .column-hidden { display: none; }
        .row-is-collapsible { cursor: pointer; }
        .row-is-collapsible:hover { background-color: var(--table-row-hover); }
        
        .toggle-icon {
            display: none;
            font-weight: bold;
            font-size: 1.3em;
            padding: 0 5px;
            width: 10px;
            text-align: center;
            color: var(--accent);
            user-select: none;
        }
        
        .toggle-icon.visible { display: inline-block; }
        
        .child-row > td {
            background-color: var(--child-row-details-bg);
            border-top: 2px solid var(--child-row-details-border);
        }

        .details-container { padding: 10px 15px; }
        
        .child-details-table { width: 100%; border-collapse: collapse; }
        .child-details-table td {
            padding: 8px;
            border: none;
            border-bottom: 1px solid var(--light-gray);
            white-space: normal;
        }
        .child-details-table tr:last-child td { border-bottom: none; }
        .child-details-table td:first-child {
            width: 150px;
            font-weight: bold;
            color: var(--dark);
        }
        
        /* Table Column Specific Styles */
        .description-column {
            width: 100%;
            min-width: 100px;
            white-space: normal;
            word-wrap: break-word;
            overflow: visible;
            text-overflow: clip;
        }

        .col-no { width: 75px; }
        .col-no-s { width: 40px; }
        .col-drag { width: 20px; }
        .col-date { width: 100px; }
        .date-wrap { display: none; }
        .col-branch { width: 75px; }
        .col-amount, .col-balance, .col-total { width: 150px; text-align: right; }
        .col-dbcr { width: 75px; }
        .col-rank { width: 60px; text-align: center; }
        .col-actions { width: 85px; text-align: right; white-space: nowrap;}
        .col-number { text-align: right; }
        .col-empty-state { text-align: center; padding: 40px;}

        /* Category Table Specific */
        #categoryTable tbody tr.parent-row:hover {
            background-color: var(--table-row-hover);
        }

        /* Summary Table Specific */
        #summaryTable tbody tr.parent-row { cursor: pointer; }
        .summary-table .total-row {
            font-weight: bold;
            background-color: var(--summary-details-total-bg) !important;
            position: sticky;
            bottom: 0;
        }
        body.dark-theme .summary-table .total-row { color: var(--white); }

        /* --- 2.6 Forms --- */
        .data-form,
        .summary-controls {
            background: var(--light-gray);
            padding: var(--spacing);
            border-radius: var(--border-radius);
            display: flex;
            gap: var(--spacing);
            flex-shrink: 0;
        }

        .data-form { flex-direction: column; }
        .summary-controls { flex-direction: row; align-items: flex-end; flex-wrap: wrap; }
        
        body.dark-theme .data-form, 
        body.dark-theme .summary-controls { 
            background: var(--light-gray); 
        }

        .data-form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .data-form-header h3 { font-size: 1.1rem; }
        .data-form-header .toggle-icon { transition: transform 0.3s ease; }
        .data-form-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .data-form-content { display: flex; flex-direction: column; gap: var(--spacing); }
        .data-form-content.collapsed { display: none; }
        
        .form-row { display: flex; gap: var(--spacing); flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; margin-bottom: var(--spacing); font-weight: 500; }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background: var(--form-input-bg);
            color: var(--dark);
        }

        body.dark-theme .form-group input, 
        body.dark-theme .form-group textarea, 
        body.dark-theme .form-group select {
            background: var(--form-input-bg);
            color: var(--dark);
            border-color: var(--form-input-border);
        }

        .form-actions {
            display: flex;
            gap: var(--spacing);
        }
        
        .input-with-button {
            display: flex;
            align-items: center;
            gap: var(--spacing);
        }

        .input-with-button input {
            flex-grow: 1;
        }

        #keywordSearchMode {
            flex-shrink: 0;
            width: 65px;
        }

        .keyword-list {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .keyword-tag {
            background: var(--primary);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .json-controls {
            padding-top: var(--spacing);
            display: flex;
            justify-content: flex-end;
        }

        /* --- 2.7 Modals --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: var(--overlay-bg);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show { display: flex; }

        .modal-content {
            background: var(--light);
            padding: var(--spacing);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: var(--spacing);
            max-height: 90vh;
        }
        
        #instructions .modal-content { max-width: 600px; }
        #instructions ul { padding-left: 20px; }

        .modal-header {
            padding: var(--spacing);
            border-bottom: 1px solid var(--light-gray);
        }
        
        .modal-content h2 { padding: var(--spacing); }

        .modal-body {
            flex-grow: 1;
            overflow-y: auto;
        }

        .modal-close-btn {
            position: absolute;
            top: 10px; right: 10px;
            background: none; border: none; font-size: 1.5rem; color: var(--gray); cursor: pointer;
        }
        
        .modal-controls { 
            display: flex; 
            gap: var(--spacing); 
        }

        textarea.paste-area, textarea.json-editable {
            width: 100%;
            min-height: 200px;
            padding: var(--spacing);
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            background-color: var(--table-row-odd);
            resize: vertical;
            font-family: 'Courier New', monospace;
            color: var(--dark);
        }

        textarea.json-editable {
            flex-grow: 1;
        }

        .summary-details-total-row {
            font-weight: bold;
            background-color: var(--summary-details-total-bg);
            border-top: 2px solid var(--child-row-details-border);
        }

        /* --- 2.8 Collapsible Data View ("All Data" Tab) --- */
        .all-data-controls { 
            display: flex; 
            gap: var(--spacing); 
            padding: 0 var(--spacing); 
        }

        .collapsible-header {
            cursor: pointer;
            padding: 8px 10px;
            background-color: var(--secondary);
            color: var(--white);
            font-weight: bold;
            border-radius: 6px;
            margin-top: var(--spacing);
            display: grid;
            grid-template-columns: auto 1fr repeat(3, 150px) auto;
            align-items: center;
            gap: 15px;
        }

        .collapsible-header:hover { background-color: var(--primary); }
        .collapsible-header.month-header { 
            background: linear-gradient(to right, var(--accent), #000);
            color: var(--dark); 
            font-size: 1rem; 
        }
        .collapsible-header.year-header { 
            background: linear-gradient(to right, var(--secondary), #000);
            color: var(--dark); 
            font-size: 1rem; 
        }

        .collapsible-header .icon { transition: transform 0.3s ease; width: 16px; height: 16px; }
        .collapsible-content { padding-left: var(--spacing); display: none; overflow: hidden; }
        .collapsible-content.open { display: block; }

        .header-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .total-cr, .total-db, .total-delta {
            font-size: 0.9em;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            text-align: right;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .total-cr { color: var(--success); }
        .total-db { color: var(--danger); }
        .delta-positive { color: var(--success); }
        .delta-negative { color: var(--danger); }

        /* --- 2.9 Loading & Notifications --- */
        #loading-overlay {
            position: fixed; inset: 0; background: var(--loader-overlay-bg);
            z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        
        .loading-box { 
            background: var(--light); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            text-align: center; 
            width: 90%; 
            max-width: 400px; 
        }

        .spinner {
            border: 6px solid var(--light-gray); border-top: 6px solid var(--primary);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px auto;
        }
        
        #loading-steps { list-style: none; text-align: left; }
        #loading-steps li { padding: 5px 0; color: var(--gray); display: flex; align-items: center; gap: 10px; }
        #loading-steps li.pending .status-icon::before { font-family: "Font Awesome 6 Free"; font-weight: 900; content: "\f110"; animation: spin 1.5s linear infinite; }
        #loading-steps li.completed { color: var(--dark); }
        #loading-steps li.completed .status-icon { color: var(--success); }
        #loading-steps li.completed .status-icon::before { font-family: "Font Awesome 6 Free"; font-weight: 900; content: "\f058"; }
        #loading-steps li.failed { color: var(--danger); }
        #loading-steps li.failed .status-icon { color: var(--danger); }
        #loading-steps li.failed .status-icon::before { font-family: "Font Awesome 6 Free"; font-weight: 900; content: "\f057"; }
        
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .notification-item {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            color: var(--white);
            font-weight: 500;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease-in-out;
            max-width: 350px;
        }

        .notification-item.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            flex-grow: 1; color: var(--gray); text-align: center; padding: 20px;
        }
        
        .empty-state i { font-size: 3rem; margin-bottom: 15px; opacity: 0.2; }

        /* --- 2.10 jQuery UI / Drag-and-Drop --- */
        .drag-handle { cursor: grab; padding: 0 10px; color: var(--gray); }
        .ui-sortable-placeholder { 
            height: 40px; 
            background: var(--sortable-placeholder-bg); 
            visibility: visible !important; 
        }
        .ui-sortable-helper { 
            background: var(--sortable-helper-bg); 
            color: var(--white); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
        }
        
        /* --- 2.11 Bond Compare View --- */
        /* Default state: show list/form, hide compare view */
        #bond-content .data-form,
        #bond-content #bond-table-container {
            display: flex; /* .data-form is a flex-column */
            flex-direction: column;
        }
        #bond-content #bond-table-container {
            display: block; /* The container itself is a block */
        }
        #bond-content #bond-compare-view {
            display: none;
        }

        /* When in compare mode, hide list/form and show compare view */
        #bond-content.view-compare .data-form,
        #bond-content.view-compare #bond-table-container {
            display: none;
        }
        #bond-content.view-compare #bond-compare-view {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        
        #bond-compare-controls {
            padding: var(--spacing);
            border-bottom: 1px solid var(--light-gray);
            flex-shrink: 0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }
        #bond-compare-controls label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        #bond-compare-table-container {
            flex-grow: 1;
            overflow: auto; /* Allows both horizontal and vertical scrolling */
        }
        #bondCompareTable {
            width: auto; /* Let the table size itself based on its columns */
            border-spacing: 0;
        }
        #bondCompareTable th, #bondCompareTable td {
            border: 1px solid var(--light-gray);
            text-align: center;
            padding: 8px 10px;
        }
        #bondCompareTable thead th {
            background-color: var(--light-gray);
            color: var(--white);
            position: sticky;
            top: 0;
            z-index: 2;
        }
        #bondCompareTable tbody td:first-child,
        #bondCompareTable thead th:first-child {
            position: sticky;
            left: 0;
            background-color: var(--primary);
            color: var(--white);
            z-index: 1;
        }
        /* Style the top-left corner cell */
        #bondCompareTable thead tr:nth-child(1) th:first-child {
            z-index: 3;
        }
        #bondCompareTable thead tr:nth-child(2) th:first-child {
            z-index: 3;
        }
        .header-maturity {
            display: block;
            font-size: 0.8em;
            font-weight: normal;
            font-style: italic;
        }

        /* --- 2.12 Dropdown Component --- */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            /* Uses existing .btn styles */
            width: 100%;
            text-align: left;
            justify-content: space-between; /* Puts icon on the right */
        }

        /* Adds the caret icon to the button */
        .dropdown-toggle::after {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            content: '\f0d7'; /* fa-caret-down */
            transition: transform 0.2s ease-in-out;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: var(--light);
            min-width: 260px; /* Set a minimum width */
            box-shadow: var(--box-shadow);
            border: 1px solid var(--form-input-border);
            border-radius: var(--border-radius);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px 0;
        }

        body.dark-theme .dropdown-menu {
            background-color: var(--light-gray);
            border-color: var(--form-input-border);
        }

        .dropdown-menu.show {
            display: block;
        }

        /* Rotate caret when the menu is shown */
        .dropdown-menu.show + .dropdown-toggle::after {
            transform: rotate(180deg);
        }

        .dropdown-menu label {
            display: block;
            padding: 8px 15px;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px; /* Space between checkbox and text */
        }

        .dropdown-menu label:hover {
            background-color: var(--table-row-hover);
        }

        .dropdown-menu input[type="checkbox"] {
            /* Style the checkbox itself if needed */
            width: 16px;
            height: 16px;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
        }

        /* --- 2.13 Password Toggle (Updated) --- */
        .form-group {
            position: relative; /* This is needed to position the icon */
        }

        .password-toggle-icon {
            position: absolute;
            right: 15px; /* Positions the icon on the right side */
            bottom: 11px; /* Aligns the icon vertically within the input field */
            color: var(--gray);
            cursor: pointer;
            transition: color 0.2s ease;
            /* The previous top/transform properties are no longer needed */
        }

        .password-toggle-icon:hover {
            color: var(--primary);
        }

        /* ==========================================================================
           3. UTILITY & STATE CLASSES
           ========================================================================== */
        .money-cell { 
            text-align: right !important; /* Override generic td style */
            font-family: 'Courier New', Courier, monospace; 
        }

        .dual-value {
            line-height: 1.3;
            vertical-align: middle;
        }
        
        .dual-value .calc-value {
            display: block;
            font-size: 0.8em;
            color: var(--gray);
            font-style: italic;
        }
        
        .dual-value .above-expec { color: var(--success); }
        .dual-value .below-expec { color: var(--danger); }
        
        .d-none { display: none !important; } /* Utility to hide elements */

        /* ==========================================================================
           4. ANIMATIONS
           ========================================================================== */
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* ==========================================================================
           5. MOBILE RESPONSIVE STYLES
           ========================================================================== */
        @media (max-width: 768px) {
            /* --- Core Layout Redefined for Mobile --- */
            html, body {
                overflow: auto; 
                -webkit-overflow-scrolling: touch;
            }

            body {
                /* Adjust padding for BOTH top and bottom bars */
                padding: 5px;
                padding-top: 70px; /* Space for the new top bar */
                padding-bottom: 70px; /* Space for the existing bottom bar */
            }

            /* --- CRITICAL: Neuter the sidebar container so it doesn't create a blank column --- */
            .sidebar {
                width: 0 !important; 
                padding: 0;
                box-shadow: none;
                background: transparent;
                transition: none;
                cursor: default;
            }

            /* --- NEW: Target the main menu specifically and make it a fixed top bar --- */
            .sidebar-main-menu {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 65px;
                z-index: 1010;
                
                /* Arrange items horizontally */
                display: flex;
                flex-direction: row;
                justify-content: space-around;
                width: 100%;
                gap: 0;
                
                /* Style the bar itself */
                background: var(--light);
                border-bottom: 1px solid var(--light-gray);
                padding: 0; /* Override any existing padding */
            }

            /* --- Sidebar Footer becomes the fixed bottom bar (no change in concept) --- */
            .sidebar-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 65px;
                z-index: 1010;
                display: flex;
                flex-direction: row;
                align-items: stretch;
                background: var(--light);
                border-top: 1px solid var(--light-gray);
                padding: 0;
                gap: 0;
            }
            
            /* --- Shared styles for items in BOTH top and bottom bars --- */
            .sidebar-main-menu .menu-item,
            .sidebar-footer-menu .menu-item {
                flex: 1;
                flex-direction: column;
                justify-content: center;
                gap: 4px;
                padding: 5px 2px;
                border-radius: 0;
            }
            
            /* --- Hide text labels in BOTH bars for a cleaner mobile look --- */
            .sidebar-main-menu .menu-item span,
            .sidebar-footer-menu .menu-item span,
            .sidebar-footer .status-text-wrapper {
                display: none;
            }
            
            /* --- Target the footer menu container directly --- */
            .sidebar-footer-menu {
                display: flex;
                flex-direction: row;
                justify-content: space-around;
                width: 100%;
                flex-grow: 1;
                gap: 0;
            }
            
            /* --- Floating Action Button (Sync) --- */
            .sidebar-header {
                position: fixed;
                bottom: 75px; /* Position above the bottom bar */
                left: 15px;    /* Adjusted position since left rail is gone */
                z-index: 1011;
                padding: 0;
                border: none;
            }

            .sync-all-btn {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            }
            .sync-all-btn span { display: none; }
            .sync-all-btn i { font-size: 1.2rem; }

            /* --- Dark Theme Overrides for New Mobile Elements --- */
            body.dark-theme .sidebar-main-menu {
                background: var(--light-gray);
                border-bottom-color: var(--form-input-border);
            }
            body.dark-theme .sidebar-footer {
                background: var(--light-gray);
                border-top-color: var(--form-input-border);
            }

            /* 
             * =============================================
             * NEW: Specific override for Last Update item
             * =============================================
            */
            #lastUpdateInfo i {
                display: none; /* Hide the clock icon */
            }

            #lastUpdateInfo .status-text-wrapper,
            #lastUpdateInfo .status-text-wrapper span {
                display: flex; /* Show the text container, overriding the generic 'display: none' */
                flex-direction: column; /* Stack the label and value vertically */
                align-items: center; /* Center them horizontally */
                font-size: 0.7rem; /* Make text a bit smaller to fit nicely */
                line-height: 1.2;
            }
            
            /* --- Hide Elements Not Needed on Mobile --- */
            #sidebar-toggle-btn,
            .sidebar.collapsed .menu-item::after {
                display: none;
            }

            /* --- Other General Mobile Adjustments (Unchanged) --- */
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .card-header h2 { font-size: 1.25rem; }
            .card-header-actions { flex-wrap: wrap; width: 100%; gap: 5px; }
            .form-row, .summary-controls { flex-direction: column; align-items: stretch; }
            .form-group { min-width: 100%; }
            th, td { font-size: 0.85rem; }
            .modal-content { width: 98%; max-height: 85vh; }
            .collapsible-header { grid-template-columns: auto 1fr auto; gap: 8px; }
            .collapsible-header .total-cr,
            .collapsible-header .total-db { display: none; }
            #bond-compare-controls { flex-direction: column; align-items: flex-start; }
            
            .date-wrap {
                display: block;
            }
        }
    </style>
</head>
<body class="dark-theme">
    <!-- Sidebar -->
    <div class="sidebar dark-theme collapsed" id="sidebar">
        <div class="sidebar-header">
            <button class="btn btn-primary sync-all-btn" id="syncAllToDropboxBtn" data-tooltip="Sync All to Cloud">
                <i class="fas fa-sync fa-fw"></i> <span>Sync All</span>
            </button>
        </div>
        <div class="sidebar-menu sidebar-main-menu">
            <div class="menu-item active" data-page="home" data-tooltip="Account Statement">
                <i class="fas fa-university fa-fw"></i> <span>Account Statement</span>
            </div>
            <div class="menu-item" data-page="search" data-tooltip="Search">
                <i class="fas fa-search fa-fw"></i> <span>Search</span>
            </div>
            <div class="menu-item" data-page="summary" data-tooltip="Summary">
                <i class="fas fa-chart-pie fa-fw"></i> <span>Summary</span>
            </div>
            <div class="menu-item" data-page="category" data-tooltip="Categories">
                <i class="fas fa-tags fa-fw"></i> <span>Categories</span>
            </div>
            <div class="menu-item" data-page="bond" data-tooltip="Bonds">
                <i class="fas fa-scroll fa-fw"></i> <span>Bonds</span>
            </div>
        </div>
        <div class="sidebar-footer">
            <div class="sidebar-menu sidebar-footer-menu">
                <div class="menu-item" id="infoMenuItem" data-tooltip="How to Use">
                    <i class="fas fa-info-circle fa-fw"></i> <span>How to Use</span>
                </div>                
                <div class="menu-item" id="changePasswordBtn" data-tooltip="Change Password">
                    <i class="fas fa-key fa-fw"></i> <span>Change Password</span>
                </div>
                <div class="menu-item status-item" id="authStatus" data-tooltip="Dropbox Connection">
                    <i class="fas fa-user-lock fa-fw status-icon"></i>
                    <div class="status-text-wrapper">
                        <span>Dropbox</span>
                        <span class="status-value">Not connected</span>
                    </div>
                </div>
                <div class="menu-item status-item" id="lastUpdateInfo" data-tooltip="Last Update Time">
                    <i class="fas fa-clock fa-fw"></i>
                    <div class="status-text-wrapper">
                        <span>Last update</span>
                        <span class="status-value">-</span>
                    </div>
                </div>
                <div class="menu-item" id="sidebar-toggle-btn" data-tooltip="Expand">
                    <i class="fas fa-chevron-right fa-fw"></i> <span>Expand</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content dark-theme" id="mainContent">
        <main>
            <!-- Account Statement Page -->
            <div id="home-content" class="page-content active">
                <div class="card dark-theme">
                    <div class="card-header">
                        <h2><i class="fas fa-university"></i> Account Statement</h2>
                        <div class="card-header-actions">
                            <button id="showAddModalBtn" class="btn btn-primary">
                                <i class="fas fa-plus-circle"></i> Add New
                            </button>
                            <button id="uploadBtn" class="btn btn-dropbox">
                                <i class="fas fa-cloud-upload-alt"></i> Save
                            </button>
                        </div>
                    </div>
                    <div class="tabs">
                        <div class="tab active" data-tab="recent">Recent</div>
                        <div class="tab" data-tab="all">All Data</div>
                        <div class="tab" data-tab="json">JSON</div>
                    </div>
                    <div id="recent-content" class="tab-content active">
                        <div class="table-container">
                            <table id="recentTable">
                                <thead>
                                    <tr>
                                        <th class="toggle-column column-hidden"></th>
                                        <th class="col-no" data-priority="8">No</th>
                                        <th class="col-date" data-priority="1">Date</th>
                                        <th class="description-column" data-priority="2">Description</th>
                                        <th class="col-branch" data-priority="7">Branch</th>
                                        <th class="col-amount" data-priority="3">Amount</th>
                                        <th class="col-dbcr" data-priority="6"></th>
                                        <th class="col-balance" data-priority="4">Balance</th>
                                        <th class="col-total" data-priority="5">Total</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="all-content" class="tab-content">
                        <div class="all-data-controls">
                            <button id="expandAllBtn" class="btn btn-secondary btn-small"><i class="fas fa-expand-arrows-alt"></i> Expand</button>
                            <button id="collapseAllBtn" class="btn btn-secondary btn-small"><i class="fas fa-compress-arrows-alt"></i> Collapse</button>
                        </div>
                        <div class="tab-body dark-theme" id="all-table-container">
                            <div class="empty-state"><i class="fas fa-table"></i><p>Parsed data appears here.</p></div>
                        </div>
                    </div>
                    <div id="json-content" class="tab-content">
                        <textarea id="jsonEditor" class="json-editable dark-theme"></textarea>
                        <div class="json-controls">
                            <button id="saveJsonBtn" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Search Page -->
            <div id="search-content" class="page-content">
                <div class="card dark-theme">
                    <div class="card-header">
                        <h2><i class="fas fa-search"></i> Search Transactions</h2>
                    </div>
                    <div class="data-form">
                        <div class="data-form-header" id="searchFormHeader">
                            <h3><i class="fas fa-filter"></i> Search Filters</h3>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                        <div class="data-form-content" id="searchFormContent">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label for="searchKeywords">Keywords (comma separated)</label>
                                    <div class="input-with-button">
                                        <input type="text" id="searchKeywords" placeholder="e.g., salary, shopping, e-banking" class="dark-theme">
                                        <button id="keywordSearchMode" class="btn btn-secondary" data-mode="OR">OR</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="searchStartDate">Start Date</label>
                                    <input type="date" id="searchStartDate" class="dark-theme">
                                </div>
                                <div class="form-group">
                                    <label for="searchEndDate">End Date</label>
                                    <input type="date" id="searchEndDate" class="dark-theme">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="searchMinAmount">Min Amount</label>
                                    <input type="number" id="searchMinAmount" placeholder="0.00" class="dark-theme" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label for="searchMaxAmount">Max Amount</label>
                                    <input type="number" id="searchMaxAmount" placeholder="10000.00" class="dark-theme" step="0.01">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button id="searchBtn" class="btn btn-primary"><i class="fas fa-search"></i> Search</button>
                                <button id="clearSearchBtn" class="btn btn-secondary"><i class="fas fa-eraser"></i> Clear</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container" id="searchResultContainer">
                        <div class="empty-state">
                            <i class="fas fa-search-plus"></i>
                            <p>Use the form above to search your transactions.</p>
                        </div>
                        <table id="searchResultTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th class="toggle-column column-hidden"></th>
                                    <th class="col-no" data-priority="5">No</th>
                                    <th class="col-date" data-priority="1">Date</th>
                                    <th class="description-column" data-priority="2">Description</th>
                                    <th class="col-amount" data-priority="3">Amount</th>
                                    <th class="col-dbcr" data-priority="4"></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Summary Page -->
            <div id="summary-content" class="page-content">
                <div class="card dark-theme">
                    <div class="card-header">
                        <h2><i class="fas fa-chart-pie"></i> Statement Summary</h2>
                    </div>
                    <div class="summary-controls dark-theme">
                        <div class="form-group"><label for="summaryYear">Year</label><select id="summaryYear" class="dark-theme"></select></div>
                        <div class="form-group">
                            <label for="summaryMonth">Month</label>
                            <select id="summaryMonth" class="dark-theme">
                                <option value="-1">All Year</option><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option>
                            </select>
                        </div>
                        <button id="generateSummaryBtn" class="btn btn-primary"><i class="fas fa-calculator"></i> Show</button>
                    </div>
                    <div class="table-container" id="summaryResultContainer">
                        <table id="summaryTable" class="summary-table">
                            <thead>
                                <tr>
                                    <th class="toggle-column column-hidden"></th>
                                    <th class="col-no-s">No.</th>
                                    <th data-priority="1">Category</th>
                                    <th class="col-number" data-priority="3">Month CR</th>
                                    <th class="col-number" data-priority="4">Month DB</th>
                                    <th class="col-number" data-priority="2">Month Total</th>
                                    <th class="col-number" data-priority="6">Year CR</th>
                                    <th class="col-number" data-priority="7">Year DB</th>
                                    <th class="col-number" data-priority="5">Year Total</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Category Page -->
            <div id="category-content" class="page-content">
                <div class="card dark-theme">
                    <div class="card-header">
                        <h2><i class="fas fa-tags"></i> Categories</h2>
                        <button id="uploadCategoryBtn" class="btn btn-dropbox"><i class="fas fa-cloud-upload-alt"></i> Save</button>
                    </div>
                    <div class="data-form">
                        <div class="data-form-header" id="categoryFormHeader">
                            <h3><i class="fas fa-plus-circle"></i> Add New Category</h3>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                        <div class="data-form-content" id="categoryFormContent">
                            <div class="form-group">
                                <label for="categoryName">Category Name</label>
                                <input type="text" id="categoryName" placeholder="e.g., Income, Shopping" class="dark-theme">
                            </div>
                            <div class="form-group">
                                <label for="categoryKeywords">Keywords (comma separated)</label>
                                <textarea id="categoryKeywords" placeholder="e.g., salary, bonus, shop" class="dark-theme" rows="2"></textarea>
                            </div>
                            <div class="form-group form-actions">
                                <button id="addCategoryBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Add</button>
                                <button id="clearCategoryFormBtn" class="btn btn-secondary"><i class="fas fa-eraser"></i> Clear</button>
                                <button id="updateCategoryBtn" class="btn btn-warning d-none"><i class="fas fa-edit"></i> Update</button>
                                <button id="cancelEditBtn" class="btn btn-secondary d-none"><i class="fas fa-times"></i> Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="categoryTable">
                            <thead>
                                <tr>
                                    <th class="toggle-column column-hidden"></th>
                                    <th class="col-drag"></th>
                                    <th class="col-rank" data-priority="2">Rank</th>
                                    <th data-priority="1">Name</th>
                                    <th data-priority="3">Keywords</th>
                                    <th class="col-actions"></th>
                                </tr>
                            </thead>
                            <tbody id="categoryTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
             <!-- Bond Page -->
             <div id="bond-content" class="page-content">
                <div class="card dark-theme">
                    <div class="card-header">
                        <h2><i class="fas fa-scroll"></i> Bonds</h2>
                        <div class="card-header-actions">
                            <label for="showMaturedBonds" class="btn btn-secondary" style="user-select: none; line-height: 1.5;">
                                <input type="checkbox" id="showMaturedBonds" style="margin-right: 8px; vertical-align: middle;"> Show Matured
                            </label>
                            <button id="compareBondsBtn" class="btn btn-secondary"><i class="fas fa-balance-scale"></i> Compare</button>
                            <button id="uploadBondBtn" class="btn btn-dropbox"><i class="fas fa-cloud-upload-alt"></i> Save</button>
                        </div>
                    </div>
                    <div class="data-form">
                        <div class="data-form-header" id="bondFormHeader">
                            <h3><i class="fas fa-plus-circle"></i> Add New Bond</h3>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                        <div class="data-form-content" id="bondFormContent">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bondSerial">Serial</label>
                                    <input type="text" id="bondSerial" placeholder="e.g., ORI000" class="dark-theme">
                                </div>
                                <div class="form-group">
                                    <label for="bondType">Type</label>
                                    <input type="text" id="bondType" placeholder="e.g., Spread or Fixed" class="dark-theme">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bondCapital">Capital</label>
                                    <input type="number" id="bondCapital" placeholder="10000.00" class="dark-theme">
                                </div>
                                <div class="form-group">
                                    <label for="bondReturn">Return (% p.a.)</label>
                                    <input type="number" id="bondReturn" step="0.01" placeholder="5.50" class="dark-theme">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bondSettlement">Settlement Date</label>
                                    <input type="date" id="bondSettlement" class="dark-theme">
                                </div>
                                <div class="form-group">
                                    <label for="bondMaturity">Maturity Date</label>
                                    <input type="date" id="bondMaturity" class="dark-theme">
                                </div>
                            </div>
                            <div class="form-group form-actions">
                                <button id="addBondBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Add</button>
                                <button id="clearBondFormBtn" class="btn btn-secondary"><i class="fas fa-eraser"></i> Clear</button>
                                <button id="updateBondBtn" class="btn btn-warning d-none"><i class="fas fa-edit"></i> Update</button>
                                <button id="cancelBondEditBtn" class="btn btn-secondary d-none"><i class="fas fa-times"></i> Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container" id="bond-table-container">
                        <table id="bondTable">
                            <thead>
                                <tr>
                                    <th class="toggle-column column-hidden"></th>
                                    <th data-priority="1">Serial</th>
                                    <th data-priority="2" class="col-number">Capital</th>
                                    <th data-priority="11">Type</th>
                                    <th data-priority="3" class="col-number">Return</th>
                                    <th data-priority="6">Settlement</th>
                                    <th data-priority="7">Maturity</th>
                                    <th data-priority="9" class="col-number">Month</th>
                                    <th data-priority="10" class="col-number">Year</th>
                                    <th data-priority="4" class="col-number">Monthly Return</th>
                                    <th data-priority="5" class="col-number">Total Return</th>
                                    <th data-priority="8" class="col-number">%</th>
                                    <th class="col-actions"></th>
                                </tr>
                            </thead>
                            <tbody id="bondTableBody"></tbody>
                        </table>
                    </div>
                    <!-- NEW: Bond comparison view container. NOTE: Removed d-none class. -->
                    <div id="bond-compare-view">
                        <!-- Content injected by JavaScript -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals and Overlays -->
    <div id="passwordModal" class="modal-overlay">
        <div class="modal-content dark-theme" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="passwordModalTitle"></h2>
            </div>
            <div class="modal-body">
                <p id="passwordModalPrompt" style="margin-bottom: 15px;"></p>
                <div class="form-group">
                    <label for="passwordInput">Password</label>
                    <input type="password" id="passwordInput" class="dark-theme" autocomplete="current-password">
                    <i class="fas fa-eye password-toggle-icon"></i>
                </div>
            </div>
            <div class="modal-controls">
                <button id="passwordSubmitBtn" class="btn btn-primary">Confirm</button>
                <button id="passwordCancelBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
          
    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal-overlay">
        <div class="modal-content dark-theme" style="max-width: 450px;">
            <button id="closeChangePasswordModalBtn" class="modal-close-btn"><i class="fas fa-times"></i></button>
            <div class="modal-header">
                <h2><i class="fas fa-key"></i> Change Password</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="oldPasswordInput">Old Password</label>
                    <input type="password" id="oldPasswordInput" class="dark-theme" autocomplete="current-password">
                    <i class="fas fa-eye password-toggle-icon"></i>
                </div>
                <div class="form-group">
                    <label for="newPasswordInput">New Password</label>
                    <input type="password" id="newPasswordInput" class="dark-theme" autocomplete="new-password">
                    <i class="fas fa-eye password-toggle-icon"></i>
                </div>
                <div class="form-group">
                    <label for="retypePasswordInput">Retype New Password</label>
                    <input type="password" id="retypePasswordInput" class="dark-theme" autocomplete="new-password">
                    <i class="fas fa-eye password-toggle-icon"></i>
                </div>
            </div>
            <div class="modal-controls">
                <button id="confirmChangePasswordBtn" class="btn btn-primary">Confirm Change</button>
                <button id="cancelChangePasswordBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>    

    <div id="addRecordModal" class="modal-overlay">
        <div class="modal-content dark-theme">
            <button id="closeModalBtn" class="modal-close-btn"><i class="fas fa-times"></i></button>
            <h2><i class="fas fa-paste"></i> Paste Your Data</h2>
            <textarea id="pasteArea" class="paste-area dark-theme" placeholder="Paste your table data here..."></textarea>
            <div class="modal-controls">
                <button id="parseBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Add Data</button>
                <button id="clearPasteAreaBtn" class="btn btn-secondary"><i class="fas fa-eraser"></i> Clear</button>
                <button id="sampleBtn" class="btn btn-warning"><i class="fas fa-lightbulb"></i> Sample</button>
                <button id="dummyDataBtn" class="btn btn-dropbox"><i class="fas fa-magic"></i> Dummy Data</button>
            </div>
        </div>
    </div>
    <div id="instructions" class="modal-overlay">
        <div class="modal-content dark-theme">
            <button class="modal-close-btn" id="closeInstructions"><i class="fas fa-times"></i></button>
            <h2><i class="fas fa-info-circle"></i> How to Use</h2>
            <div class="tab-body dark-theme">
                <ul>
                    <li><strong>First Steps:</strong>
                        <ul>
                            <li>Upon loading, you will be prompted for a <strong>password</strong>. This is used to encrypt your data before it's saved, ensuring your privacy. Remember this password!</li>
                            <li>In the sidebar, click the <strong>Dropbox status</strong> ("Not connected") to link your Dropbox account. This is required for saving and loading data.</li>
                            <li>You can change your encryption password at any time using the <strong>"Change Password"</strong> option in the sidebar.</li>
                        </ul>
                    </li>
                    <li><strong>Account Statement Page:</strong>
                        <ul>
                            <li>Click <strong>"Add New"</strong> to open the paste dialog. For testing, you can use the "Sample" or "Dummy Data" buttons.</li>
                            <li>Copy transaction rows from your online bank statement and paste them into the text area, then click <strong>"Add Data"</strong>.</li>
                            <li>The <strong>Recent</strong> tab shows the data you just added, while the <strong>All Data</strong> tab shows your complete transaction history.</li>
                            <li>Click the main <strong>"Save"</strong> button on this page to upload your encrypted bank statement to Dropbox.</li>
                        </ul>
                    </li>
                    <li><strong>Search Page:</strong>
                        <ul>
                            <li>Use the filters to find specific transactions.</li>
                            <li>Enter comma-separated keywords. Use the <strong>OR/AND</strong> toggle button to define the search logic:
                                <ul>
                                    <li><strong>OR (default):</strong> Finds transactions matching at least one keyword.</li>
                                    <li><strong>AND:</strong> Finds transactions matching all keywords.</li>
                                </ul>
                            </li>
                            <li>You can also filter by a date range and/or a minimum/maximum amount.</li>
                        </ul>
                    </li>
                     <li><strong>Categories Page:</strong>
                        <ul>
                             <li>Define rules here to automatically categorize your spending for the Summary page.</li>
                             <li>Add a category with a name (e.g., "Utilities") and keywords (e.g., "electricity, internet, water").</li>
                             <li>A transaction will now be included in the totals for <strong>every</strong> category whose keywords it matches.</li>
                             <li>You can <strong>drag and drop</strong> rows to change their rank. This will controls the visual display order on this page and in the Summary report.</li>
                             <li>Click <strong>"Save"</strong> on this page to upload your category rules to Dropbox.</li>
                        </ul>
                    </li>
                    <li><strong>Summary Page:</strong>
                        <ul>
                            <li>Get a categorized breakdown of your finances. Select a year and month, then click <strong>"Show"</strong>.</li>
                            <li>The table displays credit, debit, and total amounts for the selected period and the full year.</li>
                            <li>Click on any category row to see a detailed list of all transactions that were grouped into that line item.</li>
                        </ul>
                    </li>
                    <li><strong>Bonds Page:</strong>
                        <ul>
                            <li>Track your bond investments and their returns.</li>
                            <li>The table automatically calculates expected returns and compares them against actual coupon payments found in your bank statement.</li>
                            <li>Click a bond row to see the specific transactions from your statement that are linked to it.</li>
                            <li>Use the <strong>"Compare"</strong> button to see a side-by-side coupon payment schedule for all your bonds.</li>
                            <li>Use the <strong>"Show Matured"</strong> checkbox to include or hide bonds that are past their maturity date.</li>
                        </ul>
                    </li>
                     <li><strong>Syncing & Mobile Usage:</strong>
                        <ul>
                            <li>Click the <strong>"Sync All"</strong> button (top-left on desktop, floating button on mobile) to save your Statement, Categories, and Bonds to Dropbox in one go.</li>
                            <li>On small screens, tables become responsive. If columns are hidden to fit the screen, a <strong>`+`</strong> icon will appear. Click it to expand the row and view the hidden information.</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div id="summaryDetailModal" class="modal-overlay">
        <div class="modal-content dark-theme">
            <button id="closeSummaryDetailModalBtn" class="modal-close-btn"><i class="fas fa-times"></i></button>
            <div class="modal-header">
                <h2 id="summaryDetailTitle"><i class="fas fa-list-ul"></i> Details</h2>
            </div>
            <div class="modal-body" id="summaryDetailBody">
                <!-- Details will be injected here by JavaScript -->
            </div>
        </div>
    </div>
    <div id="loading-overlay">
        <div class="loading-box dark-theme">
            <div class="spinner"></div>
            <ul id="loading-steps"></ul>
        </div>
    </div>
    <div id="notification-container">        
    </div>

    
<script>
    // The existing JavaScript code remains unchanged as requested.
    // It will work with the updated HTML and CSS structure.
    document.addEventListener('DOMContentLoaded', function() {
        const DEFAULT_DROPBOX_PATH = '/saving-book/statement.json';
        const CATEGORY_DROPBOX_PATH = '/master/categories.json';
        const BOND_DROPBOX_PATH = '/master/bonds.json';
        const APP_KEY = 'hrxfrcq435yhye9';
        const REDIRECT_URI = window.location.href.split("index.html")[0] + "index.html";
        // Cache DOM elements for performance
        const pasteArea = document.getElementById('pasteArea');
        const parseBtn = document.getElementById('parseBtn');
        const clearPasteAreaBtn = document.getElementById('clearPasteAreaBtn');
        const sampleBtn = document.getElementById('sampleBtn');
        const dummyDataBtn = document.getElementById('dummyDataBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadCategoryBtn = document.getElementById('uploadCategoryBtn');
        const allTableContainer = document.getElementById('all-table-container');
        const jsonContent = document.getElementById('json-content');
        const jsonEditor = document.getElementById('jsonEditor');
        const saveJsonBtn = document.getElementById('saveJsonBtn');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        const authStatus = document.getElementById('authStatus');
        const lastUpdateInfo = document.getElementById('lastUpdateInfo');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const pageMenuItems = document.querySelectorAll('.sidebar-menu .menu-item[data-page]');
        const infoMenuItem = document.getElementById('infoMenuItem');
        const showAddModalBtn = document.getElementById('showAddModalBtn');
        const addRecordModal = document.getElementById('addRecordModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const expandAllBtn = document.getElementById('expandAllBtn');
        const collapseAllBtn = document.getElementById('collapseAllBtn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingSteps = document.getElementById('loading-steps');
        const instructions = document.getElementById('instructions');
        const closeInstructions = document.getElementById('closeInstructions');
        // Category page elements
        const categoryName = document.getElementById('categoryName');
        const categoryKeywords = document.getElementById('categoryKeywords');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const updateCategoryBtn = document.getElementById('updateCategoryBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const categoryTableBody = document.getElementById('categoryTableBody');
        const homeContent = document.getElementById('home-content');
        const categoryContent = document.getElementById('category-content');
        const categoryFormHeader = document.getElementById('categoryFormHeader');
        const categoryFormContent = document.getElementById('categoryFormContent');
        const clearCategoryFormBtn = document.getElementById('clearCategoryFormBtn');
        // Summary page elements
        const summaryContent = document.getElementById('summary-content');
        const summaryYear = document.getElementById('summaryYear');
        const summaryMonth = document.getElementById('summaryMonth');
        const generateSummaryBtn = document.getElementById('generateSummaryBtn');
        const summaryResultContainer = document.getElementById('summaryResultContainer');
        const summaryDetailModal = document.getElementById('summaryDetailModal');
        const closeSummaryDetailModalBtn = document.getElementById('closeSummaryDetailModalBtn');
        const summaryDetailTitle = document.getElementById('summaryDetailTitle');
        const summaryDetailBody = document.getElementById('summaryDetailBody');
        // Bond page elements
        const bondContentPage = document.getElementById('bond-content');
        const compareBondsBtn = document.getElementById('compareBondsBtn');
        const bondCompareView = document.getElementById('bond-compare-view');
        const bondFormHeader = document.getElementById('bondFormHeader');
        const bondFormContent = document.getElementById('bondFormContent');
        const bondTableBody = document.getElementById('bondTableBody');
        const addBondBtn = document.getElementById('addBondBtn');
        const updateBondBtn = document.getElementById('updateBondBtn');
        const cancelBondEditBtn = document.getElementById('cancelBondEditBtn');
        const uploadBondBtn = document.getElementById('uploadBondBtn');
        const bondSerial = document.getElementById('bondSerial');
        const bondType = document.getElementById('bondType');
        const bondCapital = document.getElementById('bondCapital');
        const bondReturn = document.getElementById('bondReturn');
        const bondSettlement = document.getElementById('bondSettlement');
        const bondMaturity = document.getElementById('bondMaturity');
        const clearBondFormBtn = document.getElementById('clearBondFormBtn');
        const showMaturedBonds = document.getElementById('showMaturedBonds');
        // Search page elements
        const searchKeywords = document.getElementById('searchKeywords');
        const keywordSearchMode = document.getElementById('keywordSearchMode');
        const searchStartDate = document.getElementById('searchStartDate');
        const searchEndDate = document.getElementById('searchEndDate');
        const searchMinAmount = document.getElementById('searchMinAmount');
        const searchMaxAmount = document.getElementById('searchMaxAmount');
        const searchBtn = document.getElementById('searchBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const searchResultContainer = document.getElementById('searchResultContainer');
        const searchResultTable = document.getElementById('searchResultTable');
        const searchFormHeader = document.getElementById('searchFormHeader');
        const searchFormContent = document.getElementById('searchFormContent');
        // Sidebar buttons
        const syncAllToDropboxBtn = document.getElementById('syncAllToDropboxBtn');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        // START: New "Change Password" elements
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const changePasswordModal = document.getElementById('changePasswordModal');
        const closeChangePasswordModalBtn = document.getElementById('closeChangePasswordModalBtn');
        const cancelChangePasswordBtn = document.getElementById('cancelChangePasswordBtn');
        const confirmChangePasswordBtn = document.getElementById('confirmChangePasswordBtn');
        const oldPasswordInput = document.getElementById('oldPasswordInput');
        const newPasswordInput = document.getElementById('newPasswordInput');
        const retypePasswordInput = document.getElementById('retypePasswordInput');
        const passwordToggleIcons = document.querySelectorAll('.password-toggle-icon');
        // END: New "Change Password" elements

        let isCategoryFormCollapsed = false;
        let isBondFormCollapsed = false;
        let isSearchFormCollapsed = false;
        // Application state
        let accessToken = null;
        let refreshToken = null;
        let tokenExpiresAt = null;
        let parsedData = [];
        let recentlyAddedData = [];
        let categories = [];
        let editingCategoryIndex = -1;
        let bonds = [];
        let editingBondIndex = -1;
        let password = '';
        const updateFunctions = new Map();

        // ==========================================================================
        // START: ADD ENCRYPTION/DECRYPTION FUNCTIONS
        // ==========================================================================

        function getPassword(title, promptText) {
            return new Promise((resolve, reject) => {
                const modal = document.getElementById('passwordModal');
                const titleEl = document.getElementById('passwordModalTitle');
                const promptEl = document.getElementById('passwordModalPrompt');
                const passwordInput = document.getElementById('passwordInput');
                const submitBtn = document.getElementById('passwordSubmitBtn');
                const cancelBtn = document.getElementById('passwordCancelBtn');

                titleEl.textContent = title;
                promptEl.textContent = promptText;
                passwordInput.value = '';

                const handleSubmit = () => {
                    cleanup();
                    resolve(passwordInput.value);
                };

                const handleCancel = () => {
                    cleanup();
                    reject(new Error('User cancelled password entry.'));
                };
                const handleKeypress = (e) => {
                    if (e.key === 'Enter') {
                        handleSubmit();
                    }
                };
                const cleanup = () => {
                    submitBtn.removeEventListener('click', handleSubmit);
                    cancelBtn.removeEventListener('click', handleCancel);
                    passwordInput.removeEventListener('keypress', handleKeypress);
                    modal.classList.remove('show');
                };

                submitBtn.addEventListener('click', handleSubmit);
                cancelBtn.addEventListener('click', handleCancel);
                passwordInput.addEventListener('keypress', handleKeypress);

                modal.classList.add('show');
                passwordInput.focus();
            });
        }
        // Helper to convert ArrayBuffer to Base64 string
        function bufferToBase64(buf) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(buf)));
        }
        // Helper to convert Base64 string to ArrayBuffer
        function base64ToBuffer(b64) {
            const byteString = atob(b64);
            const bytes = new Uint8Array(byteString.length);
            for (let i = 0; i < byteString.length; i++) {
                bytes[i] = byteString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        // Derives a key from a password and salt using PBKDF2
        async function getKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                enc.encode(password), {
                    name: 'PBKDF2'
                },
                false, ['deriveKey']
            );
            return crypto.subtle.deriveKey({
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial, {
                    name: 'AES-GCM',
                    length: 256
                },
                true, ['encrypt', 'decrypt']
            );
        }
        // Encrypts a data object (e.g., parsedData) with a password
        async function encryptData(dataObject, password) {
            const enc = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const key = await getKey(password, salt);

            const plaintext = JSON.stringify(dataObject);
            const encodedPlaintext = enc.encode(plaintext);

            const ciphertext = await crypto.subtle.encrypt({
                    name: 'AES-GCM',
                    iv: iv
                },
                key,
                encodedPlaintext
            );

            // Package everything into a single JSON object for storage
            return JSON.stringify({
                salt: bufferToBase64(salt),
                iv: bufferToBase64(iv),
                ciphertext: bufferToBase64(ciphertext)
            });
        }
        // Decrypts an encrypted payload with a password
        async function decryptData(encryptedPayload, password) {
            try {
                const {
                    salt,
                    iv,
                    ciphertext
                } = encryptedPayload;
                const saltBuffer = base64ToBuffer(salt);
                const ivBuffer = base64ToBuffer(iv);
                const cipherBuffer = base64ToBuffer(ciphertext);

                const key = await getKey(password, saltBuffer);

                const decryptedBuffer = await crypto.subtle.decrypt({
                        name: 'AES-GCM',
                        iv: ivBuffer
                    },
                    key,
                    cipherBuffer
                );

                const dec = new TextDecoder();
                const decryptedPlaintext = dec.decode(decryptedBuffer);

                return JSON.parse(decryptedPlaintext);
            } catch (error) {
                console.error("Decryption failed:", error);
                throw new Error("Decryption failed. Please check your password and ensure the file is not corrupted.");
            }
        }
        // ==========================================================================
        // END: ADD ENCRYPTION/DECRYPTION FUNCTIONS
        // ==========================================================================
        // Initialize app
        initializeApp();

        async function initializeApp() {
            setupEventListeners();

            try {
                 password = await getPassword(
                    'Encrypt Files',
                    'Enter a password to encrypt your file before uploading. Remember this password!'
                );
            } catch (e) {
                document.body.innerHTML = `<div class="empty-state" style="height: 100vh;"><i class="fas fa-lock"></i><p>Password is required to use the application. Please refresh to try again.</p></div>`
                return;
            }

            const authCode = handleOAuthRedirect();
            if (authCode) {
                history.replaceState(null, null, window.location.pathname);

                showLoading(['Finalizing Dropbox connection...']);
                // This function will get the tokens and save them to localStorage.
                await exchangeCodeForToken(authCode);
                hideLoading();
            }

            // Load tokens from localStorage
            accessToken = localStorage.getItem('dropboxAccessToken');
            refreshToken = localStorage.getItem('dropboxRefreshToken');
            tokenExpiresAt = localStorage.getItem('dropboxTokenExpiresAt');

            updateAuthStatus(!!accessToken);

            updateFunctions.set('recent', initializeResponsiveTable('#recentTable'));
            updateFunctions.set('all', initializeResponsiveTable('#all-table-container'));
            updateFunctions.set('search', initializeResponsiveTable('#searchResultTable'));
            updateFunctions.set('bond', initializeResponsiveTable('#bondTable'));
            updateFunctions.set('summary', initializeResponsiveTable('#summaryTable'));
            updateFunctions.set('category', initializeResponsiveTable('#categoryTable'));

            if (accessToken) {
                await loadDataTypeFromDropbox({
                    dropboxPath: DEFAULT_DROPBOX_PATH,
                    dataTypeName: 'Bank Statement',
                    options: {
                        showSuccessNotification: true,
                        loadingUi: {
                            steps: ['Connecting to Dropbox', 'Downloading data', 'Populating application']
                        }
                    },
                    successHandler: (data, metadata) => {
                        if (metadata) {
                            lastUpdateInfo.querySelector('.status-value').innerHTML = formatDate(metadata.client_modified);
                        }
                        parsedData = Array.isArray(data) ? data : [];
                        recentlyAddedData = []; // Clear recent data on a full load
                        parsedData.forEach((row, index) => row.No = index + 1);
                        renderAllViews();
                    }
                });

                await loadDataTypeFromDropbox({
                    dropboxPath: CATEGORY_DROPBOX_PATH,
                    dataTypeName: 'Categories',
                    successHandler: (data) => {
                        if (Array.isArray(data)) {
                            categories = data;
                            // Ensure rank property exists and sort
                            categories.forEach((cat, index) => {
                                if (typeof cat.rank !== 'number') cat.rank = index;
                            });
                            categories.sort((a, b) => a.rank - b.rank);
                            renderCategories();
                        }
                    }
                });

                await loadDataTypeFromDropbox({
                    dropboxPath: BOND_DROPBOX_PATH,
                    dataTypeName: 'Bonds',
                    successHandler: (data) => {
                        if (Array.isArray(data)) {
                            bonds = data;
                            renderBonds();
                        }
                    }
                });
            }

            setToggleState(sidebar.classList.contains('collapsed'));
            renderAllViews();
            renderCategories();
            renderBonds();
            // Trigger the initial update for the default visible page/tab
            const initialPageUpdate = updateFunctions.get('home-content');
            if (initialPageUpdate) initialPageUpdate();

            const initialTabUpdate = updateFunctions.get('recent');
            if (initialTabUpdate) initialTabUpdate();
            // Single, global resize handler that updates all tables
            let resizeTimer;
            $(window).on('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    for (const fn of updateFunctions.values()) {
                        fn();
                    }
                }, 250);
            });
        }

        function setupEventListeners() {
            // New toggle button logic
            sidebarToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isCollapsing = !sidebar.classList.contains('collapsed');
                sidebar.classList.toggle('collapsed');
                setToggleState(isCollapsing);
                // Give the animation time to finish, then update all tables
                setTimeout(() => {
                    for (const fn of updateFunctions.values()) {
                        fn();
                    }
                }, 350);
            });

            // New: Click on sidebar background to toggle
            sidebar.addEventListener('click', (e) => {
                const interactiveElement = e.target.closest('.menu-item, .btn');
                if (interactiveElement) return;

                const isCollapsing = !sidebar.classList.contains('collapsed');
                sidebar.classList.toggle('collapsed');
                setToggleState(isCollapsing);
                setTimeout(() => {
                    for (const fn of updateFunctions.values()) {
                        fn();
                    }
                }, 350);
            });

            syncAllToDropboxBtn.addEventListener('click', (e) => {
                e.stopPropagation();                
                if (!confirm('Are you sure you want to save the current data to Dropbox?')) return;
                syncAllData();
            });

            // --- PAGE SWITCHING (FIXED) ---
            pageMenuItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    pageMenuItems.forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
                    item.classList.add('active');
                    const pageKey = item.dataset.page;
                    document.getElementById(`${pageKey}-content`)?.classList.add('active');
                    // *** FIX: Trigger the update for the specific page being shown ***
                    const updateFn = updateFunctions.get(pageKey);
                    if (updateFn) {
                        updateFn();
                    }

                    // If we are switching to the home page, we also need to trigger the responsive
                    // logic for whichever tab is currently active within it ('recent', 'all', or 'json').
                    if (pageKey === 'home') {
                        const activeTabKey = document.querySelector('#home-content .tab.active')?.dataset.tab;
                        const tabUpdateFn = updateFunctions.get(activeTabKey);
                        if (tabUpdateFn) {
                            tabUpdateFn();
                        }
                    }
                });
            });

            infoMenuItem.addEventListener('click', (e) => {
                e.stopPropagation();
                instructions.classList.add('show');
            });

            // --- TAB SWITCHING (FIXED) ---
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#home-content .tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    const tabKey = tab.dataset.tab;
                    document.getElementById(`${tabKey}-content`).classList.add('active');
                    // *** FIX: Trigger the update for the specific tab being shown ***
                    const updateFn = updateFunctions.get(tabKey);
                    if (updateFn) {
                        updateFn();
                    }
                    if (tab.dataset.tab === 'json') {
                        jsonEditor.value = JSON.stringify(parsedData, null, 2);
                    }
                });
            });

            // --- Search Page Listeners ---
            searchBtn.addEventListener('click', performSearch);
            clearSearchBtn.addEventListener('click', clearSearch);
            
            keywordSearchMode.addEventListener('click', () => {
                const currentMode = keywordSearchMode.dataset.mode;
                if (currentMode === 'OR') {
                    keywordSearchMode.dataset.mode = 'AND';
                    keywordSearchMode.textContent = 'AND';
                } else {
                    keywordSearchMode.dataset.mode = 'OR';
                    keywordSearchMode.textContent = 'OR';
                }
            });

            searchFormHeader.addEventListener('click', () => {
                isSearchFormCollapsed = !isSearchFormCollapsed;
                searchFormContent.classList.toggle('collapsed');
                searchFormHeader.classList.toggle('collapsed');
            });
            
             // START: Event listeners for the new Change Password modal
            changePasswordBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                changePasswordModal.classList.add('show');
            });

            closeChangePasswordModalBtn.addEventListener('click', () => {
                changePasswordModal.classList.remove('show');
                resetChangePasswordForm();
            });

            cancelChangePasswordBtn.addEventListener('click', () => {
                changePasswordModal.classList.remove('show');
                resetChangePasswordForm();
            });

            confirmChangePasswordBtn.addEventListener('click', handleChangePassword);

            passwordToggleIcons.forEach(icon => {
                icon.addEventListener('click', (e) => {
                    const input = e.target.previousElementSibling;
                    if (input.type === 'password') {
                        input.type = 'text';
                        e.target.classList.remove('fa-eye');
                        e.target.classList.add('fa-eye-slash');
                    } else {
                        input.type = 'password';
                        e.target.classList.remove('fa-eye-slash');
                        e.target.classList.add('fa-eye');
                    }
                });
            });
            // END: Event listeners for the new Change Password modal


            // --- Other existing event listeners ---
            showAddModalBtn.addEventListener('click', () => addRecordModal.classList.add('show'));
            closeModalBtn.addEventListener('click', () => addRecordModal.classList.remove('show'));
            addRecordModal.addEventListener('click', (e) => {
                if (e.target === addRecordModal) addRecordModal.classList.remove('show');
            });
            closeInstructions.addEventListener('click', () => instructions.classList.remove('show'));
            instructions.addEventListener('click', (e) => {
                if (e.target === instructions) instructions.classList.remove('show');
            });
            closeSummaryDetailModalBtn.addEventListener('click', () => summaryDetailModal.classList.remove('show'));
            summaryDetailModal.addEventListener('click', (e) => {
                if (e.target === summaryDetailModal) summaryDetailModal.classList.remove('show');
            });
            parseBtn.addEventListener('click', async () => {
                await addData();
                if (recentlyAddedData.length > 0) {
                    addRecordModal.classList.remove('show');
                }
            });
            clearPasteAreaBtn.addEventListener('click', () => pasteArea.value = '');
            sampleBtn.addEventListener('click', loadSample);
            dummyDataBtn.addEventListener('click', handleDummyData);
            authStatus.addEventListener('click', (e) => {
                e.stopPropagation();
                handleDropboxConnection();
            });
            uploadBtn.addEventListener('click', () => {
                if (!confirm('Are you sure you want to save the current Bank Statement to Dropbox?')) return;
                uploadDataToDropbox({
                    data: parsedData,
                    dropboxPath: DEFAULT_DROPBOX_PATH,
                    dataTypeName: 'Bank Statement',
                    options: {
                        showUi: true
                    }
                })
            });
            uploadCategoryBtn.addEventListener('click', () => {
                if (!confirm('Are you sure you want to save the current Categories to Dropbox?')) return;
                uploadDataToDropbox({
                    data: categories,
                    dropboxPath: CATEGORY_DROPBOX_PATH,
                    dataTypeName: 'Categories',
                    options: {
                        showUi: true
                    }
                })
            });
            allTableContainer.addEventListener('click', function(e) {
                const header = e.target.closest('.collapsible-header');
                if (header) {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.icon');
                    content.classList.toggle('open');
                    icon.style.transform = content.classList.contains('open') ? 'rotate(90deg)' : 'rotate(0deg)';
                }
            });
            expandAllBtn.addEventListener('click', () => toggleAll(true));
            collapseAllBtn.addEventListener('click', () => toggleAll(false));
            saveJsonBtn.addEventListener('click', saveJsonChanges);
            addCategoryBtn.addEventListener('click', addCategory);
            updateCategoryBtn.addEventListener('click', updateCategory);
            cancelEditBtn.addEventListener('click', cancelEdit);
            clearCategoryFormBtn.addEventListener('click', resetCategoryForm);
            categoryFormHeader.addEventListener('click', () => {
                isCategoryFormCollapsed = !isCategoryFormCollapsed;
                categoryFormContent.classList.toggle('collapsed');
                categoryFormHeader.classList.toggle('collapsed');
            });
            // Bond Page Listeners
            uploadBondBtn.addEventListener('click', () => {
                if (!confirm('Are you sure you want to save the current Bonds to Dropbox?')) return;
                uploadDataToDropbox({
                    data: bonds,
                    dropboxPath: BOND_DROPBOX_PATH,
                    dataTypeName: 'Bonds',
                    options: {
                        showUi: true
                    }
                })
            });
            addBondBtn.addEventListener('click', addBond);
            updateBondBtn.addEventListener('click', updateBond);
            cancelBondEditBtn.addEventListener('click', cancelBondEdit);
            clearBondFormBtn.addEventListener('click', resetBondForm);
            bondFormHeader.addEventListener('click', () => {
                isBondFormCollapsed = !isBondFormCollapsed;
                bondFormContent.classList.toggle('collapsed');
                bondFormHeader.classList.toggle('collapsed');
            });
            bondTableBody.addEventListener('click', handleBondTableClick);
            compareBondsBtn.addEventListener('click', () => {
                const isInCompareView = bondContentPage.classList.contains('view-compare');
                if (isInCompareView) {
                    bondContentPage.classList.remove('view-compare');
                    compareBondsBtn.innerHTML = `<i class="fas fa-balance-scale"></i> Compare`;
                    compareBondsBtn.classList.remove('btn-primary');
                    compareBondsBtn.classList.add('btn-secondary');
                } else {
                    bondContentPage.classList.add('view-compare');
                    renderBondComparePage();
                    compareBondsBtn.innerHTML = `<i class="fas fa-list-ul"></i> Back to List`;
                    compareBondsBtn.classList.remove('btn-secondary');
                    compareBondsBtn.classList.add('btn-primary');
                }
            });
            showMaturedBonds.addEventListener('change', () => {
                // Re-render the main bond list with the filter applied
                renderBonds();

                // If in compare view, re-render that as well
                const isInCompareView = bondContentPage.classList.contains('view-compare');
                if (isInCompareView) {
                    renderBondComparePage();
                }
            });
            if (window.innerWidth < 768) {
                categoryFormContent.classList.add('collapsed');
                categoryFormHeader.classList.add('collapsed');
                bondFormContent.classList.add('collapsed');
                bondFormHeader.classList.add('collapsed');
            }
            generateSummaryBtn.addEventListener('click', generateSummary);
            $('#categoryTableBody').sortable({
                handle: '.drag-handle',
                placeholder: 'ui-sortable-placeholder',
                helper: 'clone',
                update: function(event, ui) {
                    // Get only the main data rows in their new order
                    const newOrderElements = Array.from(categoryTableBody.children)
                        .filter(row => row.classList.contains('parent-row'));

                    // Extract the category names from the rows in their new visual order
                    const orderedCategoryNames = newOrderElements.map(row => row.children[3].textContent.trim());

                    // Re-assign the 'rank' property on the original categories array
                    // This is safer than replacing the entire array and avoids errors.
                    categories.forEach(cat => {
                        const newRank = orderedCategoryNames.indexOf(cat.name);
                        if (newRank !== -1) {
                            cat.rank = newRank;
                        }
                    });
                    // Re-render the table, which will use the new ranks to sort the data correctly
                    renderCategories();
                    showNotification('Category order updated!', 'success');
                }
            }).disableSelection();
        }

        // START: New functions for Change Password modal
        function resetChangePasswordForm() {
            oldPasswordInput.value = '';
            newPasswordInput.value = '';
            retypePasswordInput.value = '';

            // Reset all password fields to be of type "password" and icons to "fa-eye"
            passwordToggleIcons.forEach(icon => {
                const input = icon.previousElementSibling;
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            });
        }

        function handleChangePassword() {
            const oldPass = oldPasswordInput.value;
            const newPass = newPasswordInput.value;
            const retypePass = retypePasswordInput.value;

            // Validation checks
            if (!oldPass || !newPass || !retypePass) {
                showNotification('All password fields are required.', 'danger');
                return;
            }

            if (oldPass !== password) {
                showNotification('The old password you entered is incorrect.', 'danger');
                return;
            }

            if (newPass !== retypePass) {
                showNotification('The new passwords do not match.', 'danger');
                return;
            }

            if (newPass === oldPass) {
                showNotification('The new password cannot be the same as the old password.', 'warning');
                return;
            }

            // All checks passed, update the password
            password = newPass;
            showNotification('Password changed successfully!\nYour files will now be encrypted with the new password.', 'success');

            // Hide the modal and clear the form
            changePasswordModal.classList.remove('show');
            resetChangePasswordForm();

            // Upload all files using new password
            syncAllData();
        }
        // END: New functions for Change Password modal

        function setToggleState(isCollapsed) {
            const toggleIcon = sidebarToggleBtn.querySelector('i');
            const toggleText = sidebarToggleBtn.querySelector('span');
            const toggleTooltip = sidebarToggleBtn;
            if (isCollapsed) {
                toggleIcon.style.transform = 'rotate(0deg)';
                toggleText.textContent = 'Expand';
                toggleTooltip.dataset.tooltip = 'Expand';
            } else {
                toggleIcon.style.transform = 'rotate(180deg)';
                toggleText.textContent = 'Collapse';
                toggleTooltip.dataset.tooltip = 'Collapse';
            }
        }

        function showLoading(steps) {
            loadingSteps.innerHTML = '';
            steps.forEach(stepText => {
                const li = document.createElement('li');
                li.classList.add('pending');
                li.innerHTML = `<span class="status-icon"></span><span class="text">${stepText}</span>`;
                loadingSteps.appendChild(li);
            });
            loadingOverlay.style.display = 'flex';
        }
        async function updateLoadingStep(index, status = 'completed', message = null) {
            const step = loadingSteps.children[index];
            if (step) {
                step.classList.remove('pending');
                step.classList.add(status);
                if (message) {
                    step.querySelector('.text').textContent = message;
                }
            }
        }
        async function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function formatMoney(num, digits = 2) {
            if (isNaN(num)) return '0.00';
            const sign = num < 0 ? "-" : "";
            const value = Math.abs(num);
            return sign + parseFloat(value).toLocaleString('en-US', {
                minimumFractionDigits: digits,
                maximumFractionDigits: digits
            });
        }

        function renderAllViews() {
            renderRecentData();
            renderAllData();
            populateSummaryFilters();
            renderBonds();
        }

        function renderRecentData() {
            const container = document.getElementById('recent-content').querySelector('.table-container');
            const table = container.querySelector('table');
            const tbody = table.querySelector('tbody');
            const totalColumns = document.querySelectorAll('#recentTable thead th').length;
            table.querySelector('thead').innerHTML = `
                    <tr>
                        <th class="toggle-column column-hidden"></th>
                        <th class="col-no" data-priority="8">No</th>
                        <th class="col-date" data-priority="1">Date</th>
                        <th class="description-column" data-priority="2">Description</th>
                        <th class="col-branch" data-priority="7">Branch</th>
                        <th class="col-amount" data-priority="3">Amount</th>
                        <th class="col-dbcr" data-priority="6"></th>
                        <th class="col-balance" data-priority="4">Balance</th>
                        <th class="col-total" data-priority="5">Total</th>
                    </tr>
                `;
            if (recentlyAddedData.length === 0) {
                const existingEmptyState = container.querySelector('.empty-state');
                if (existingEmptyState) existingEmptyState.remove();
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = '<i class="fas fa-history"></i><p>Data from your latest import will appear here</p>';
                container.insertBefore(emptyState, table);

                table.style.display = 'none';
                return;
            }
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
            table.style.display = 'table';
            tbody.innerHTML = '';
            recentlyAddedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'parent-row';
                tr.innerHTML = `
                        <td class="toggle-column column-hidden"><span class="toggle-icon"></span></td>
                        <td>${row.No}</td>
                        <td>${formatDate(row.Date)}</td>
                        <td class="description-column">${row.Description}</td>
                        <td>${row.Branch}</td>
                        <td class="money-cell">${formatMoney(row.Amount)}</td>
                        <td>${row.DBCR}</td>
                        <td class="money-cell">${formatMoney(row.Balance)}</td>
                        <td class="money-cell">${formatMoney(row.Total)}</td>
                    `;
                tbody.appendChild(tr);
                const childRow = document.createElement('tr');
                childRow.className = 'child-row column-hidden';
                childRow.innerHTML = `<td colspan="${totalColumns}"></td>`;
                tbody.appendChild(childRow);
            });

            const updateFn = updateFunctions.get('recent');
            if (updateFn) {
                updateFn();
            }
        }

        function renderAllData() {
            const container = allTableContainer;
            if (parsedData.length === 0) {
                container.innerHTML = `<div class="empty-state"><i class="fas fa-table"></i><p>Your parsed table data will appear here</p></div>`;
                return;
            }

            const groupedData = parsedData.reduce((acc, row) => {
                const date = new Date(row.Date.split('/').reverse().join('-'));
                const year = date.getFullYear();
                const month = date.toLocaleString('default', {
                    month: 'long'
                });
                if (!acc[year]) acc[year] = {};
                if (!acc[year][month]) acc[year][month] = [];
                acc[year][month].push(row);
                return acc;
            }, {});
            let finalHtml = '';
            const years = Object.keys(groupedData).sort((a, b) => b - a);
            const latestYear = years[0];
            const monthsInLatestYear = Object.keys(groupedData[latestYear]).sort((a, b) => new Date(Date.parse(b + " 1, 2012")) - new Date(Date.parse(a + " 1, 2012")));
            const latestMonth = monthsInLatestYear[0];

            years.forEach(year => {
                let yearCredit = 0;
                let yearDebit = 0;
                let monthsHtml = '';
                const isLatestYear = year == latestYear;
                const months = Object.keys(groupedData[year]).sort((a, b) => new Date(Date.parse(b + " 1, 2012")) - new Date(Date.parse(a + " 1, 2012")));
                months.forEach(month => {
                    const rows = groupedData[year][month];
                    let monthCredit = 0;
                    let monthDebit = 0;
                    rows.forEach(row => {
                        const amount = parseFloat(row.Amount) || 0;
                        if (row.DBCR === 'CR') monthCredit += amount;
                        else if (row.DBCR === 'DB') monthDebit += amount;
                    });
                    yearCredit += monthCredit;
                    yearDebit += monthDebit;
                    const monthDelta = monthCredit - monthDebit;
                    const isLatestMonth = isLatestYear && month === latestMonth;
                    const uniqueId = `group-${year}-${month.replace(' ', '')}`;
                    monthsHtml += `
                            <div class="collapsible-header month-header" data-group="${uniqueId}">
                                <span class="header-title">${month} ${year}</span>
                                <div></div>
                                <span class="total-cr">+${formatMoney(monthCredit)}</span>
                                <span class="total-db">-${formatMoney(monthDebit)}</span>
                                <strong class="total-delta ${monthDelta >= 0 ? 'delta-positive' : 'delta-negative'}">${formatMoney(monthDelta)}</strong>
                                <i class="fas fa-chevron-right icon" style="transform: ${isLatestMonth ? 'rotate(90deg)' : 'rotate(0deg)'};"></i>
                            </div>
                            <div class="collapsible-content month-content ${isLatestMonth ? 'open' : ''}" data-group-content="${uniqueId}" ${isLatestMonth ? 'id="latest-month-group"' : ''}>`;

                    const headers = Object.keys(rows[0]);
                    monthsHtml += '<table><thead><tr>' +
                        '<th class="toggle-column column-hidden"></th>' +
                        '<th class="col-no" data-priority="8">No</th>' +
                        '<th class="col-date" data-priority="1">Date</th>' +
                        '<th class="description-column" data-priority="2">Description</th>' +
                        '<th class="col-branch" data-priority="6">Branch</th>' +
                        '<th class="col-dbcr" data-priority="5"></th>' +
                        '<th class="col-amount" data-priority="3">Amount</th>' +
                        '<th class="col-balance" data-priority="4">Balance</th>' +
                        '<th class="col-total" data-priority="7">Total</th>' +
                        '</tr></thead><tbody>';
                    rows.forEach(row => {
                        monthsHtml += '<tr class="parent-row">';
                        monthsHtml += '<td class="toggle-column column-hidden"><span class="toggle-icon"></span></td>';
                        headers.forEach(header => {
                            let classAttr = '';
                            let value;

                            if (header === 'Date') {
                                value = formatDate(row[header]);
                            } else if (['Amount', 'Balance', 'Total'].includes(header)) {
                                classAttr = 'class="money-cell"';
                                value = formatMoney(row[header]);
                            } else if (header === 'Description') {
                                classAttr = 'class="description-column"';
                                value = row[header] || '';
                            } else {
                                value = row[header] || '';
                            }

                            monthsHtml += `<td ${classAttr}>${value}</td>`;
                        });
                        monthsHtml += '</tr>';
                        monthsHtml += '<tr class="child-row column-hidden"><td colspan="9"></td></tr>';
                    });
                    monthsHtml += '</tbody></table></div>';
                });
                const yearDelta = yearCredit - yearDebit;
                const yearHeaderHtml = `
                        <div class="collapsible-header year-header" data-group="year-${year}">
                            <span class="header-title">Year ${year}</span>
                            <div></div>
                            <span class="total-cr">+${formatMoney(yearCredit)}</span>
                            <span class="total-db">-${formatMoney(yearDebit)}</span>
                            <strong class="total-delta ${yearDelta >= 0 ? 'delta-positive' : 'delta-negative'}">${formatMoney(yearDelta)}</strong>
                            <i class="fas fa-chevron-right icon"></i>
                        </div>
                        <div class="collapsible-content ${isLatestYear ? 'open' : ''}" data-group-content="year-${year}">
                            ${monthsHtml}
                        </div>`;

                finalHtml += yearHeaderHtml;
            });

            container.innerHTML = finalHtml;
            container.querySelectorAll('.collapsible-header .icon').forEach(icon => {
                const content = icon.closest('.collapsible-header').nextElementSibling;
                icon.style.transform = content.classList.contains('open') ? 'rotate(90deg)' : 'rotate(0deg)';
            });
            // Trigger the responsive logic update for the newly rendered tables
            const updateFn = updateFunctions.get('all');
            if (updateFn) {
                updateFn();
            }
            setTimeout(() => {
                const latestGroup = document.getElementById('latest-month-group');
                if (latestGroup) {
                    latestGroup.scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest'
                    });
                }
            }, 100);
        }

        function parseFlexibleFloat(str) {
            if (typeof str !== 'string') return NaN;
            const lastCommaIndex = str.lastIndexOf(',');
            const lastPeriodIndex = str.lastIndexOf('.');
            let decimalSeparator, thousandsSeparator;
            if (lastCommaIndex > lastPeriodIndex) {
                decimalSeparator = ',';
                thousandsSeparator = '.';
            } else {
                decimalSeparator = '.';
                thousandsSeparator = ',';
            }
            const thousandsRegex = new RegExp(`\\${thousandsSeparator}`, 'g');
            const cleanedStr = str.replace(thousandsRegex, '').replace(decimalSeparator, '.');
            return parseFloat(cleanedStr);
        }
        async function addData() {
            showLoading(['Parsing headers', 'Processing rows', 'Rendering views']);
            try {
                const text = pasteArea.value.trim();
                if (!text) {
                    await updateLoadingStep(0, 'failed', 'No data pasted.');
                    throw new Error('Please paste some data first!');
                }
                const dataStartIndex = text.search(/\d{2}\/\d{2}\/\d{4}/);
                if (dataStartIndex === -1) {
                    await updateLoadingStep(0, 'failed', "Can't find start date (DD/MM/YYYY).");
                    throw new Error('Could not find start of data.');
                }
                const headerBlock = text.substring(0, dataStartIndex);
                const dataBlock = text.substring(dataStartIndex);
                const headers = headerBlock.trim().split('\n\t\n');
                await updateLoadingStep(0, 'completed');
                const rowRegex = /(\d{2}\/\d{2}\/\d{4})[\s\S]*?(?=(\d{2}\/\d{2}\/\d{4})|$)/g;
                const rowMatches = [...dataBlock.matchAll(rowRegex)];
                const newRows = [];
                let currentRowNum = parsedData.length + 1;
                let currentTotal = parsedData.length > 0 ? parseFloat(parsedData[parsedData.length - 1].Total) : 0;
                rowMatches.forEach(r => {
                    const row = {};
                    row['No'] = currentRowNum++;
                    const c = r[0].toString().trim().split('\n\t\n');
                    let i = 0;
                    headers.forEach(h => {
                        const currentValue = c[i].replace(/\n/g, ' ').trim();
                        const nextValue = (i + 1 < c.length) ? c[i + 1].replace(/\n/g, ' ').trim().toUpperCase() : null;
                        const header = h;
                        if (header === 'Amount' && (nextValue === 'DB' || nextValue === 'CR')) {
                            row['DBCR'] = nextValue;
                            row[header] = parseFlexibleFloat(currentValue);
                            i++;
                        } else if (header === 'Amount') {
                            row[header] = parseFlexibleFloat(currentValue);
                            row['DBCR'] = '';
                            i++;
                        } else if (header === 'Balance') {
                            row[header] = parseFlexibleFloat(currentValue);
                        } else {
                            row[header] = currentValue;
                        }
                        i++;
                    });
                    const amount = parseFloat(row['Amount'] || 0);
                    if (row['DBCR'] === 'DB') currentTotal -= amount;
                    else currentTotal += amount;
                    row['Total'] = currentTotal.toFixed(2);
                    if (Object.keys(row).length > 2) newRows.push(row);
                });
                await updateLoadingStep(1, 'completed');
                recentlyAddedData = newRows;
                parsedData = [...parsedData, ...newRows];
                parsedData.forEach((row, index) => row.No = index + 1);
                renderAllViews();
                pasteArea.value = '';
                await updateLoadingStep(2, 'completed');
                showNotification(`Data added successfully! Total rows: ${parsedData.length}`, 'success');
            } catch (error) {
                showNotification(error.message, 'danger');
                console.error(error);
            } finally {
                await hideLoading();
            }
        }

        function loadSample() {
            const sampleData = `Date\n\t\nDescription\n\t\nBranch\n\t\nAmount\n\t\nBalance
05/07/2025\n\t\nTRSF E-BANKING DB\n0000/XXXXX/XX00000\n100000.00\nXXX\nASDXXXX QWEXXXX ZXC\n\t\n0000\n\t\n100,000.00\n\t\nDB\n\t\n22,222,222.22
05/07/2025\n\t\nTRSF E-BANKING DB\n0000/XXXXX/XX00000\n200000.00\nXXX\nASDXXXX QWEXXXX ZXC\n\t\n0000\n\t\n200,000.00\n\t\nCR\n\t\n222,222.22
05/07/2025\n\t\nTRSF E-BANKING DB\n0000/XXXXX/XX00000\n300000.00\nXXX\nASDXXXX QWEXXXX ZXC\n\t\n0000\n\t\n300,000.00\n\t\nDB\n\t\n222.22
                `;
            pasteArea.value = sampleData;
            showNotification('Sample data loaded!', 'success');
        }

        async function handleDummyData() {
            if (!confirm('This will erase all current data and generate a full set of dummy data for 2014-2015. Are you sure?')) {
                return;
            }

            // A helper function to get a random integer
            const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

            // A helper to pick a random item from an array
            const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];

            showLoading([
                'Clearing existing data...',
                'Generating dummy categories...',
                'Generating dummy bonds...',
                'Generating dummy statement (2 years)...',
                'Rendering all views...'
            ]);

            // Use a slight delay to allow the UI to update
            await new Promise(resolve => setTimeout(resolve, 100));

            // 1. Clear Data
            parsedData = [];
            recentlyAddedData = []; // Clear this as well
            categories = [];
            bonds = [];
            await updateLoadingStep(0, 'completed');

            // 2. Generate Categories
            categories = [
                { name: 'Income', keywords: ['monthly salary', 'performance bonus'], rank: 0 },
                { name: 'Utilities', keywords: ['electricity bill payment', 'isp charge'], rank: 1 },
                { name: 'Lifestyle & Shopping', keywords: ['supermarket groceries', 'amazon purchase', 'restaurant dining'], rank: 2 },
                { name: 'Finance & Investment', keywords: ['bond coupon', 'atm withdrawal', 'stock dividend'], rank: 3 }
            ];
            await updateLoadingStep(1, 'completed');


            // 3. Generate Bonds
            bonds = [
                {
                    serial: 'ORI018',
                    type: 'Fixed',
                    capital: 150000000,
                    return: 6.8,
                    settlement: '2014-03-11',
                    maturity: '2017-03-11' // Matures after our dummy data period
                },
                {
                    serial: 'SBR007',
                    type: 'Spread',
                    capital: 75000000,
                    return: 7.1,
                    settlement: '2013-09-20',
                    maturity: '2015-09-20' // Matures WITHIN our dummy data period
                },
                {
                    serial: 'ORI021',
                    type: 'Fixed',
                    capital: 200000000,
                    return: 5.57,
                    settlement: '2014-10-15',
                    maturity: '2027-10-15' // Matures long after
                }
            ];
            await updateLoadingStep(2, 'completed');

            // 4. Generate Statement Data
            let newStatementData = [];
            let currentTotal = 50000000;
            let recordCounter = 1;

            const expenseDescriptions = [
                'electricity bill payment', 'isp charge', 'supermarket groceries',
                'amazon purchase', 'restaurant dining', 'atm withdrawal', 'e-banking transfer to friend',
                'monthly insurance premium', 'online subscription service'
            ];
            const incomeDescriptions = ['monthly salary', 'performance bonus', 'stock dividend', 'freelance project payment'];

            for (let year = 2014; year <= 2015; year++) {
                for (let month = 0; month < 12; month++) {
                    let recordsThisMonth = [];
                    const numRecords = getRandomInt(5, 7);
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    // Add bond payments for this month
                    bonds.forEach(bond => {
                        const settlement = new Date(bond.settlement);
                        const maturity = new Date(bond.maturity);
                        const paymentDate = new Date(year, month, settlement.getDate()); // Pay on the same day as settlement

                        // Coupon Payment
                        if (paymentDate >= settlement && paymentDate < maturity) {
                            const couponAmount = ((bond.capital * (bond.return / 100)) / 12) * 0.9;
                            currentTotal += couponAmount;
                            recordsThisMonth.push({
                                No: 0, // Placeholder
                                Date: `${String(paymentDate.getDate()).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`,
                                Description: `KUPON ${bond.serial} bond coupon`,
                                Branch: '0000',
                                Amount: couponAmount,
                                DBCR: 'CR',
                                Balance: getRandomInt(10000000, 90000000),
                                Total: currentTotal
                            });
                        }

                        // Maturity Payment (Principal Return)
                        if (maturity.getFullYear() === year && maturity.getMonth() === month) {
                            const maturityDate = new Date(year, month, maturity.getDate());
                            currentTotal += bond.capital;
                            recordsThisMonth.push({
                                No: 0, // Placeholder
                                Date: `${String(maturityDate.getDate()).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`,
                                Description: `PELUNASAN POKOK ${bond.serial}`,
                                Branch: '0000',
                                Amount: bond.capital,
                                DBCR: 'CR',
                                Balance: getRandomInt(10000000, 90000000),
                                Total: currentTotal
                            });
                        }
                    });

                    // Add regular income (usually once a month)
                    const salaryDay = getRandomInt(25, 28);
                    const incomeAmount = getRandomInt(15000000, 25000000);
                    currentTotal += incomeAmount;
                    recordsThisMonth.push({
                        No: 0,
                        Date: `${String(salaryDay).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`,
                        Description: getRandomItem(incomeDescriptions).toUpperCase(),
                        Branch: '1234',
                        Amount: incomeAmount,
                        DBCR: 'CR',
                        Balance: getRandomInt(10000000, 90000000),
                        Total: currentTotal
                    });

                    // Add random expenses
                    for (let i = 0; i < numRecords; i++) {
                        const expenseDay = getRandomInt(1, daysInMonth);
                        const expenseAmount = getRandomInt(50000, 2000000);
                        currentTotal -= expenseAmount;
                        recordsThisMonth.push({
                            No: 0,
                            Date: `${String(expenseDay).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`,
                            Description: `TRSF E-BANKING DB ${getRandomItem(expenseDescriptions).toUpperCase()}`,
                            Branch: '5678',
                            Amount: expenseAmount,
                            DBCR: 'DB',
                            Balance: getRandomInt(10000000, 90000000),
                            Total: currentTotal
                        });
                    }

                    // Sort all records for the month by date before adding to the main list
                    recordsThisMonth.sort((a, b) => {
                        const dateA = new Date(a.Date.split('/').reverse().join('-'));
                        const dateB = new Date(b.Date.split('/').reverse().join('-'));
                        return dateA - dateB;
                    });

                    newStatementData.push(...recordsThisMonth);
                }
            }

            // Finally, assign correct sequential numbers
            newStatementData.forEach(row => {
                row.No = recordCounter++;
            });

            parsedData = newStatementData;

            await updateLoadingStep(3, 'completed');

            // 5. Render everything
            renderAllViews();
            renderCategories();
            renderBonds();
            await updateLoadingStep(4, 'completed');

            await hideLoading();
            addRecordModal.classList.remove('show');
            showNotification('Dummy data for 2 years has been loaded successfully!', 'success');
        }


        function toggleAll(expand) {
            const contents = allTableContainer.querySelectorAll('.collapsible-content');
            const icons = allTableContainer.querySelectorAll('.collapsible-header .icon');
            contents.forEach(content => {
                if (expand) content.classList.add('open');
                else content.classList.remove('open');
            });
            icons.forEach(icon => {
                icon.style.transform = expand ? 'rotate(90deg)' : 'rotate(0deg)';
            });
        }

        function updateAuthStatus(isConnected) {
            const statusWrapper = authStatus.querySelector('.status-text-wrapper');
            const statusValueDiv = statusWrapper.querySelector('.status-value');
            const statusIcon = authStatus.querySelector('i');
            if (isConnected) {
                authStatus.classList.remove('status-disconnected');
                authStatus.classList.add('status-connected');
                statusValueDiv.textContent = 'Connected';
            } else {
                authStatus.classList.remove('status-connected');
                authStatus.classList.add('status-disconnected');
                statusValueDiv.textContent = 'Not connected';
            }
        }

        function handleDropboxConnection() {
            if (accessToken) {
                clearDropboxAuth();
            } else {
                connectToDropbox();
            }
        }

        function clearDropboxAuth() {
            accessToken = null;
            refreshToken = null;
            tokenExpiresAt = null;
            localStorage.removeItem('dropboxAccessToken');
            localStorage.removeItem('dropboxRefreshToken');
            localStorage.removeItem('dropboxTokenExpiresAt');
            updateAuthStatus(false);
            lastUpdateInfo.querySelector('.status-value').textContent = '-';
            showNotification('Disconnected from Dropbox', 'secondary');
        }
        async function connectToDropbox() {
            // 1. Generate and store the verifier for this session.
            const verifier = generateCodeVerifier();
            sessionStorage.setItem('dropboxCodeVerifier', verifier);

            // 2. Create the challenge.
            const challenge = await generateCodeChallenge(verifier);

            // 3. Add the PKCE parameters to the authorization URL.
            const params = new URLSearchParams({
                client_id: APP_KEY,
                response_type: 'code',
                redirect_uri: REDIRECT_URI,
                token_access_type: 'offline',
                code_challenge_method: 'S256',
                code_challenge: challenge
            });

            const authUrl = `https://www.dropbox.com/oauth2/authorize?${params.toString()}`;
            window.location.href = authUrl;
        }
        async function exchangeCodeForToken(code) {
            // Retrieve the verifier we stored before redirecting
            const verifier = sessionStorage.getItem('dropboxCodeVerifier');
            if (!verifier) {
                throw new Error("Code verifier was not found in session storage.");
            }

            try {
                const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI,
                        client_id: APP_KEY,
                        // --- THIS IS THE CRITICAL ADDITION ---
                        code_verifier: verifier
                    })
                });
                if (!response.ok) {
                    // Log the detailed error from Dropbox for debugging
                    const errorBody = await response.text();
                    console.error("Dropbox token exchange failed:", errorBody);
                    throw new Error('Failed to exchange authorization code for token.');
                }
                const data = await response.json();

                accessToken = data.access_token;
                refreshToken = data.refresh_token;
                tokenExpiresAt = Date.now() + (parseInt(data.expires_in) * 1000);
                localStorage.setItem('dropboxAccessToken', accessToken);
                localStorage.setItem('dropboxRefreshToken', refreshToken);
                localStorage.setItem('dropboxTokenExpiresAt', tokenExpiresAt);
                updateAuthStatus(true);
                showNotification('Successfully connected to Dropbox!', 'success');
                // Clean up the verifier from session storage
                sessionStorage.removeItem('dropboxCodeVerifier');
            } catch (error) {
                console.error('Error exchanging code for token:', error);
                showNotification('Could not complete Dropbox connection.', 'danger');
                clearDropboxAuth();
            }
        }

        function handleOAuthRedirect() {
            const queryString = window.location.search;
            const params = new URLSearchParams(queryString);
            const code = params.get('code');

            if (code) {
                return code; // Return the code to be used by initializeApp
            }

            return null;
        }

        async function refreshAccessToken() {
            if (!refreshToken || refreshToken === 'null' || refreshToken === 'undefined') {
                clearDropboxAuth();
                // This will stop the process and force the user to re-authenticate.
                throw new Error("No valid refresh token available. Please reconnect to Dropbox.");
            }

            try {
                const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'refresh_token',
                        refresh_token: refreshToken,
                        client_id: APP_KEY
                    })
                });

                if (!response.ok) {
                    clearDropboxAuth();
                    throw new Error('Token refresh failed. Your session may have been revoked.');
                }

                const data = await response.json();
                accessToken = data.access_token;
                tokenExpiresAt = Date.now() + (parseInt(data.expires_in) * 1000);

                // Update localStorage with new tokens
                localStorage.setItem('dropboxAccessToken', accessToken);
                localStorage.setItem('dropboxTokenExpiresAt', tokenExpiresAt);

                // If a new refresh token is provided, update it
                if (data.refresh_token) {
                    refreshToken = data.refresh_token;
                    localStorage.setItem('dropboxRefreshToken', refreshToken);
                }

            } catch (error) {
                console.error('Error refreshing access token:', error);
                clearDropboxAuth();
                showNotification(error.message, 'danger');
                throw error;
            }
        }

        async function ensureValidAccessToken() {
            // If no access token, try to connect
            if (!accessToken) {
                connectToDropbox();
                return Promise.reject(new Error('No access token'));
            }

            // Check if token is expired or about to expire (within 5 minutes)
            if (tokenExpiresAt && Date.now() > (parseInt(tokenExpiresAt) - 300000)) {
                await refreshAccessToken();
            }

            return accessToken;
        }

        function generateCodeVerifier() {
            const
            charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            const randomValues = new Uint8Array(128);
            crypto.getRandomValues(randomValues);
            for (let i = 0; i < randomValues.length; i++) {
                result += charset[randomValues[i] % charset.length];
            }
            return result;
        }
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            // Base64-urlencode
            let base64 = btoa(String.fromCharCode.apply(null, hashArray));
            base64 = base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            return base64;
        }

        async function syncAllData() {
            try {
                await ensureValidAccessToken();

                const steps = ['Syncing Bank Statement', 'Syncing Categories', 'Syncing Bonds'];
                showLoading(steps);

                // Refactored the original upload functions to accept an options object
                // to prevent showing nested loading screens or notifications.
                await uploadDataToDropbox({
                    data: parsedData,
                    dropboxPath: DEFAULT_DROPBOX_PATH,
                    dataTypeName: 'Bank Statement',
                    options: {
                        showUi: false
                    }
                });
                await updateLoadingStep(0, 'completed');

                await uploadDataToDropbox({
                    data: categories,
                    dropboxPath: CATEGORY_DROPBOX_PATH,
                    dataTypeName: 'Categories',
                    options: {
                        showUi: false
                    }
                });
                await updateLoadingStep(1, 'completed');

                await uploadDataToDropbox({
                    data: bonds,
                    dropboxPath: BOND_DROPBOX_PATH,
                    dataTypeName: 'Bonds',
                    options: {
                        showUi: false
                    }
                });
                await updateLoadingStep(2, 'completed');

                lastUpdateInfo.querySelector('.status-value').innerHTML = formatDate(new Date().toISOString());
                showNotification('All data successfully synced to Dropbox!', 'success');
            } catch (error) {
                console.error('Sync All error:', error);
                showNotification('An error occurred during sync: ' + error.message, 'danger');

                const pendingStepIndex = Array.from(loadingSteps.children).findIndex(li => li.classList.contains('pending'));
                if (pendingStepIndex !== -1) {
                    await updateLoadingStep(pendingStepIndex, 'failed', `Sync failed: ${error.message}`);
                }
            } finally {
                setTimeout(hideLoading, 1500); // Delay to show final status
            }
        }
        async function loadDataTypeFromDropbox({
            dropboxPath,
            dataTypeName,
            successHandler,
            options = {}
        }) {
            const {
                loadingUi = null, showSuccessNotification = false
            } = options;

            try {
                await ensureValidAccessToken();

                // This function is only called after the initial token check, so we can proceed.
                if (loadingUi) {
                    showLoading(loadingUi.steps);
                    await updateLoadingStep(0, 'completed'); // Assumes the first step is always "Connecting".
                }
                const response = await fetch('https://content.dropboxapi.com/2/files/download', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Dropbox-API-Arg': JSON.stringify({
                            path: dropboxPath
                        })
                    }
                });
                if (response.ok) {
                    const apiResultHeader = response.headers.get('Dropbox-API-Result');
                    const metadata = apiResultHeader ? JSON.parse(apiResultHeader) : null;
                    let data = await response.json();

                    if (loadingUi) await updateLoadingStep(1, 'completed'); // Step 2: Downloading
                    // Check for and handle encrypted data
                    if (data.salt && data.iv && data.ciphertext) {
                        try {
                            data = await decryptData(data, password);
                        } catch (error) {
                            // Re-throw a more specific error to be caught below
                            throw new Error(`Decryption failed. Please check your password.`);
                        }
                    }
                    // Execute the specific success logic for this data type
                    successHandler(data, metadata);

                    if (loadingUi) await updateLoadingStep(2, 'completed'); // Step 3: Populating
                    if (showSuccessNotification) showNotification(`${dataTypeName} loaded from Dropbox!`, 'success');
                } else if (response.status === 409) {
                    // 409 means path/not_found, which is not a critical error on first load.
                    if (loadingUi) await updateLoadingStep(1, 'failed', 'File not found.');
                    console.log(`${dataTypeName} file not found at ${dropboxPath}. A new one will be created on save.`);
                } else {
                    // Handle other, more critical Dropbox API errors
                    const errorData = await response.json();
                    throw new Error(errorData.error_summary || 'An unknown Dropbox error occurred.');
                }
            } catch (error) {
                console.error(`Error loading ${dataTypeName.toLowerCase()} from Dropbox:`, error);
                // Update UI only if a loading screen was active
                if (loadingUi) {
                    // Find the current pending step to mark it as failed
                    const pendingStepIndex = Array.from(loadingSteps.children).findIndex(li => li.classList.contains('pending'));
                    if (pendingStepIndex !== -1) {
                        await updateLoadingStep(pendingStepIndex, 'failed', error.message);
                    }
                    showNotification(`Error loading ${dataTypeName}: ${error.message}`, 'danger');
                }
            } finally {
                // Hide the loading overlay only if it was shown
                if (loadingUi) {
                    setTimeout(hideLoading, 1500);
                }
            }
        }
        async function uploadDataToDropbox({
            data,
            dropboxPath,
            dataTypeName,
            options = {
                showUi: true
            }
        }) {
            try {
                await ensureValidAccessToken();
                if (!data || data.length === 0) {
                    if (options.showUi) showNotification(`No ${dataTypeName.toLowerCase()} to upload!`, 'warning');
                    return Promise.resolve(); // Not an error, just nothing to do.
                }
                if (options.showUi) {
                    showLoading([
                        `Preparing ${dataTypeName.toLowerCase()}`,
                        'Encrypting data',
                        'Uploading to Dropbox'
                    ]);
                }
                // Sort categories by rank before uploading, if applicable.
                if (dataTypeName === 'Categories') {
                    data.sort((a, b) => a.rank - b.rank);
                }
                if (options.showUi) await updateLoadingStep(0, 'completed');

                const encryptedData = await encryptData(data, password);
                if (options.showUi) await updateLoadingStep(1, 'completed');
                await performUpload(dropboxPath, encryptedData);
                if (options.showUi) {
                    await updateLoadingStep(2, 'completed');
                    // Only the main statement data updates the "Last update" timestamp
                    if (dataTypeName === 'Bank Statement') {
                        lastUpdateInfo.querySelector('.status-value').innerHTML = formatDate(new Date().toISOString());
                    }
                    showNotification(`${dataTypeName} saved successfully!`, 'success');
                }
            } catch (error) {
                const finalStepIndex = options.showUi ? 2 : -1;
                if (finalStepIndex !== -1) await updateLoadingStep(finalStepIndex, 'failed', `Upload failed for ${dataTypeName}`);

                console.error(`Upload error for ${dataTypeName}:`, error);
                if (options.showUi) showNotification(`Error uploading ${dataTypeName.toLowerCase()}: ` + error.message, 'danger');

                return Promise.reject(error); // Propagate the error for functions like syncAllData
            } finally {
                if (options.showUi) setTimeout(hideLoading, 1500);
            }
        }

        async function performUpload(filePath, jsonData) {
            const folderPath = filePath.substring(0, filePath.lastIndexOf('/'));
            if (folderPath) await createFolder(folderPath);

            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-');
            const dirPath = filePath.substring(0, filePath.lastIndexOf('/') + 1);
            const filename = filePath.substring(filePath.lastIndexOf('/') + 1);
            const nameWithoutExt = filename.substring(0, filename.lastIndexOf('.'));
            const ext = filename.substring(filename.lastIndexOf('.'));
            const mainPath = filePath;
            const backupPath = `${dirPath}${nameWithoutExt}_${timestamp}${ext}`;

            // Upload main file and backup file in parallel
            await Promise.all([
                uploadFile(mainPath, jsonData),
                uploadFile(backupPath, jsonData)
            ]);
        }
        async function createFolder(path) {
            await fetch('https://api.dropboxapi.com/2/files/create_folder_v2', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    path,
                    autorename: false
                })
            }).catch(() => {});
        }
        async function listFiles(path) {
            const response = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    path,
                    recursive: false
                })
            });

            if (!response.ok) {
                const error = await response.json();
                if (error.error_summary && error.error_summary.startsWith('path/not_found')) {
                    return {
                        entries: []
                    };
                }
                throw new Error(error.error_summary || 'Failed to list files');
            }

            return response.json();
        }
        async function deleteFile(path) {
            const response = await fetch('https://api.dropboxapi.com/2/files/delete_v2', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    path
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error_summary || 'Failed to delete file');
            }

            return response.json();
        }
        async function uploadFile(path, content) {
            const folderPath = path.substring(0, path.lastIndexOf('/'));
            if (folderPath) {
                try {
                    const folderContents = await listFiles(folderPath);
                    const files = folderContents.entries.filter(entry => entry['.tag'] === 'file');

                    // Extract filename without extension and extension from current path
                    const filename = path.substring(path.lastIndexOf('/') + 1);
                    const nameWithoutExt = filename.substring(0, filename.lastIndexOf('.'));
                    const ext = filename.substring(filename.lastIndexOf('.'));

                    // Filter files that match the backup pattern for this specific file
                    const backupFiles = files.filter(file => {
                        const fileWithoutExt = file.name.substring(0, file.name.lastIndexOf('.'));
                        const fileExt = file.name.substring(file.name.lastIndexOf('.'));
                        return file.name.startsWith(`${nameWithoutExt}_`) && fileExt === ext;
                    });

                    // Sort by modification date (oldest first)
                    backupFiles.sort((a, b) => new Date(a.client_modified) - new Date(b.client_modified));

                    // Keep only the 4 most recent backups (since we're about to add a new one)
                    while (backupFiles.length >= 5) {
                        const oldestBackup = backupFiles.shift();
                        await deleteFile(oldestBackup.path_lower);
                        console.log('Deleted old backup:', oldestBackup.path_lower);
                    }
                } catch (error) {
                    console.warn('Could not perform folder cleanup, proceeding with upload:', error.message);
                }
            }

            const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Dropbox-API-Arg': JSON.stringify({
                        path,
                        mode: 'overwrite',
                        autorename: false,
                        mute: false
                    }),
                    'Content-Type': 'application/octet-stream'
                },
                body: content
            });

            if (!response.ok) {
                const errorData = await response.text();
                console.error("Dropbox upload failed:", errorData);
                const error = JSON.parse(errorData);
                throw new Error(error.error_summary || 'Failed to upload file');
            }

            return response.json();
        }

        function formatDate(dateString) {
            if (!dateString) {
                return '';
            }
            let date;
            if (dateString instanceof Date) {
                date = dateString;
            } else if (typeof dateString === 'string' && dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    // Assumes DD/MM/YYYY format
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } else {
                // Handles YYYY-MM-DD and other ISO-like formats recognized by new Date()
                date = new Date(dateString);
            }
            if (!date || isNaN(date.getTime())) {
                return dateString; // Return original string if parsing fails
            }
            const day = date.getDate().toString().padStart(2, '0');
            const month = date.toLocaleString('default', {
                month: 'short'
            });
            const year = date.getFullYear();

            return `${day} ${month} <span class="date-wrap">\n</span>${year}`;
        }

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');

            // Create the new notification element
            const notification = document.createElement('div');
            notification.className = 'notification-item';
            notification.innerHTML = `<i class="fas fa-check-circle"></i> <span>${message.replace(/\n/g, '<br>')}</span>`;

            // Set background color based on type
            notification.style.background = type === 'danger' ? 'var(--danger)' :
                type === 'warning' ? 'var(--warning)' :
                type === 'secondary' ? 'var(--gray)' : 'var(--success)';
            // Append to the container
            container.appendChild(notification);
            // Animate it into view
            setTimeout(() => {
                notification.classList.add('show');
            }, 10); // A small delay ensures the transition is triggered
            // Set a timer to remove the notification
            setTimeout(() => {
                // Animate it out of view
                notification.classList.remove('show');

                // Remove the element from the DOM after the animation completes
                notification.addEventListener('transitionend', () => {
                    notification.remove();
                }, {
                    once: true
                });
            }, 4000); // The notification stays for 4 seconds
        }

        function saveJsonChanges() {
            if (confirm('Are you sure you want to save these changes to the JSON data? This cannot be undone.')) {
                try {
                    const newParsedData = JSON.parse(jsonEditor.value);
                    if (Array.isArray(newParsedData)) {
                        parsedData = newParsedData;
                        parsedData.forEach((row, index) => row.No = index + 1);
                        renderAllViews();
                        showNotification('JSON changes saved successfully!', 'success');
                    } else {
                        throw new Error('JSON must be an array');
                    }
                } catch (error) {
                    showNotification('Invalid JSON: ' + error.message, 'danger');
                }
            }
        }
        // --- SEARCH PAGE FUNCTIONS ---
        function performSearch() {
            let results = [...parsedData];
            // 1. Filter by Keywords
            const keywordsText = searchKeywords.value.trim().toLowerCase();
            if (keywordsText) {
                const keywords = keywordsText.split(',').map(k => k.trim()).filter(k => k);
                const searchMode = keywordSearchMode.dataset.mode;
                if (keywords.length > 0) {
                    results = results.filter(row => {
                        const description = row.Description.toLowerCase();
                        if (searchMode === 'AND') {
                            return keywords.every(kw => description.includes(kw));
                        } else { // 'OR' mode
                            return keywords.some(kw => description.includes(kw));
                        }
                    });
                }
            }
            // 2. Filter by Date Range
            const startDate = searchStartDate.value ? new Date(searchStartDate.value) : null;
            const endDate = searchEndDate.value ? new Date(searchEndDate.value) : null;

            if (startDate) startDate.setHours(0, 0, 0, 0);
            if (endDate) endDate.setHours(23, 59, 59, 999);
            if (startDate || endDate) {
                results = results.filter(row => {
                    const rowDate = new Date(row.Date.split('/').reverse().join('-'));
                    if (startDate && rowDate < startDate) return false;
                    if (endDate && rowDate > endDate) return false;
                    return true;
                });
            }

            // 3. Filter by Amount Range
            const minAmount = searchMinAmount.value ? parseFloat(searchMinAmount.value) : null;
            const maxAmount = searchMaxAmount.value ? parseFloat(searchMaxAmount.value) : null;
            if (minAmount !== null || maxAmount !== null) {
                results = results.filter(row => {
                    const amount = parseFloat(row.Amount);
                    if (minAmount !== null && amount < minAmount) return false;
                    if (maxAmount !== null && amount > maxAmount) return false;
                    return true;
                });
            }

            renderSearchResults(results);

            if (!isSearchFormCollapsed) {
                isSearchFormCollapsed = true;
                searchFormContent.classList.add('collapsed');
                searchFormHeader.classList.add('collapsed');
            }
        }

        function clearSearch() {
            searchKeywords.value = '';
            searchStartDate.value = '';
            searchEndDate.value = '';
            searchMinAmount.value = '';
            searchMaxAmount.value = '';
            renderSearchResults(null); // Pass null to show initial empty state
            if (isSearchFormCollapsed) {
                isSearchFormCollapsed = false;
                searchFormContent.classList.remove('collapsed');
                searchFormHeader.classList.remove('collapsed');
            }
        }

        function renderSearchResults(results) {
            const tbody = searchResultTable.querySelector('tbody');
            const emptyState = searchResultContainer.querySelector('.empty-state');
            tbody.innerHTML = '';

            if (results === null) { // Initial state
                emptyState.innerHTML = '<i class="fas fa-search-plus"></i><p>Use the form above to search your transactions.</p>';
                emptyState.style.display = 'flex';
                searchResultTable.style.display = 'none';
                return;
            }
            if (results.length === 0) {
                emptyState.innerHTML = '<i class="fas fa-box-open"></i><p>No transactions found matching your criteria.</p>';
                emptyState.style.display = 'flex';
                searchResultTable.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            searchResultTable.style.display = 'table';
            const totalColumns = searchResultTable.querySelectorAll('thead th').length;
            results.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'parent-row';
                tr.innerHTML = `
                        <td class="toggle-column column-hidden"><span class="toggle-icon"></span></td>
                        <td>${row.No}</td>
                        <td>${formatDate(row.Date)}</td>
                        <td class="description-column">${row.Description}</td>
                        <td class="money-cell">${formatMoney(row.Amount)}</td>
                        <td>${row.DBCR}</td>
                    `;
                tbody.appendChild(tr);
                const childRow = document.createElement('tr');
                childRow.className = 'child-row column-hidden';
                childRow.innerHTML = `<td colspan="${totalColumns}"></td>`;
                tbody.appendChild(childRow);
            });
            // Trigger responsive update
            const updateFn = updateFunctions.get('search');
            if (updateFn) {
                updateFn();
            }
        }

        function renderCategories() {
            categories.sort((a, b) => a.rank - b.rank);
            categoryTableBody.innerHTML = '';
            const totalColumns = document.querySelectorAll('#categoryTable thead th').length;

            if (categories.length === 0) {
                categoryTableBody.innerHTML = `
                        <tr>
                            <td colspan="${totalColumns}" class="col-empty-state">
                                <div class="empty-state">
                                    <i class="fas fa-tags"></i>
                                    <p>No categories yet. Add your first category!</p>
                                </div>
                            </td>
                        </tr>
                    `;
                return;
            }

            categories.forEach((category, index) => {
                const row = document.createElement('tr');
                row.className = 'parent-row';
                row.dataset.rank = category.rank;
                row.innerHTML = `
                        <td class="toggle-column column-hidden"><span class="toggle-icon"></span></td>
                        <td><i class="fas fa-grip-vertical drag-handle"></i></td>
                        <td class="col-rank">${index + 1}</td>
                        <td>${category.name}</td>
                        <td>
                            <div class="keyword-list">
                                ${category.keywords.map(keyword =>
                                    `<span class="keyword-tag">${keyword}</span>`
                                ).join('')}
                            </div>
                        </td>
                        <td class="col-actions">                            
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-small edit-category" data-index="${index}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-small delete-category" data-index="${index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                categoryTableBody.appendChild(row);
                // Add the child row for responsive data
                const childRow = document.createElement('tr');
                childRow.className = 'child-row column-hidden';
                childRow.innerHTML = `<td colspan="${totalColumns}"></td>`;
                categoryTableBody.appendChild(childRow);
            });

            document.querySelectorAll('.edit-category').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('.edit-category').dataset.index;
                    editCategory(parseInt(index));
                });
            });

            document.querySelectorAll('.delete-category').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('.delete-category').dataset.index;
                    deleteCategory(parseInt(index));
                });
            });
            // FIX: Correctly call the responsive update function from the map
            const updateFn = updateFunctions.get('category');
            if (updateFn) {
                updateFn();
            }
        }

        function addCategory() {
            const name = categoryName.value.trim();
            const keywordsText = categoryKeywords.value.trim();

            if (!name) {
                showNotification('Please enter a category name', 'danger');
                return;
            }

            if (!keywordsText) {
                showNotification('Please enter at least one keyword', 'danger');
                return;
            }

            const keywords = keywordsText.split(',')
                .map(k => k.trim())
                .filter(k => k.length > 0);

            if (keywords.length === 0) {
                showNotification('Please enter valid keywords', 'danger');
                return;
            }

            if (categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                showNotification('A category with this name already exists', 'warning');
                return;
            }

            const newCategory = {
                name,
                keywords,
                rank: categories.length
            };
            categories.push(newCategory);
            resetCategoryForm();
            renderCategories();
            showNotification(`Category "${name}" added successfully!`, 'success');

            if (!isCategoryFormCollapsed) {
                categoryFormHeader.click();
            }
        }

        function editCategory(index) {
            if (index < 0 || index >= categories.length) return;

            const category = categories[index];
            categoryName.value = category.name;
            categoryKeywords.value = category.keywords.join(', ');
            editingCategoryIndex = index;

            addCategoryBtn.classList.add('d-none');
            updateCategoryBtn.classList.remove('d-none');
            cancelEditBtn.classList.remove('d-none');
            clearCategoryFormBtn.classList.add('d-none');

            if (isCategoryFormCollapsed) {
                categoryFormHeader.click();
            }
        }

        function updateCategory() {
            if (editingCategoryIndex < 0 || editingCategoryIndex >= categories.length) return;

            const name = categoryName.value.trim();
            const keywordsText = categoryKeywords.value.trim();

            if (!name) {
                showNotification('Please enter a category name', 'danger');
                return;
            }

            if (!keywordsText) {
                showNotification('Please enter at least one keyword', 'danger');
                return;
            }

            const keywords = keywordsText.split(',')
                .map(k => k.trim())
                .filter(k => k.length > 0);

            if (keywords.length === 0) {
                showNotification('Please enter valid keywords', 'danger');
                return;
            }

            const existingIndex = categories.findIndex((c, i) =>
                c.name.toLowerCase() === name.toLowerCase() && i !== editingCategoryIndex);

            if (existingIndex !== -1) {
                showNotification('Another category already has this name', 'warning');
                return;
            }

            categories[editingCategoryIndex].name = name;
            categories[editingCategoryIndex].keywords = keywords;
            resetCategoryForm();
            renderCategories();
            showNotification(`Category "${name}" updated successfully!`, 'success');
        }

        function deleteCategory(index) {
            if (index < 0 || index >= categories.length) return;

            const categoryName = categories[index].name;
            if (confirm(`Are you sure you want to delete the category "${categoryName}"?`)) {
                categories.splice(index, 1);
                categories.forEach((cat, i) => {
                    cat.rank = i;
                });
                renderCategories();
                showNotification(`Category "${categoryName}" deleted successfully!`, 'success');

                if (editingCategoryIndex === index) {
                    resetCategoryForm();
                } else if (editingCategoryIndex > index) {
                    editingCategoryIndex--;
                }
            }
        }

        function cancelEdit() {
            resetCategoryForm();
        }

        function resetCategoryForm() {
            categoryName.value = '';
            categoryKeywords.value = '';
            editingCategoryIndex = -1;

            addCategoryBtn.classList.remove('d-none');
            updateCategoryBtn.classList.add('d-none');
            cancelEditBtn.classList.add('d-none');
            clearCategoryFormBtn.classList.remove('d-none');
        }

        function renderBonds() {
            // Filter bonds based on the "Show Matured" checkbox state
            const shouldShowMatured = showMaturedBonds.checked;
            const bondsToRender = shouldShowMatured ? [...bonds] : bonds.filter(bond => {
                if (!bond.maturity) return true; // Always show if no maturity date is set
                const maturity = new Date(bond.maturity);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Compare against the start of today
                // Keep if maturity date is invalid OR if it's in the future
                return isNaN(maturity.getTime()) || maturity >= today;
            });
            bondTableBody.innerHTML = '';
            const totalColumns = document.querySelectorAll('#bondTable thead th').length;
            if (bondsToRender.length === 0) {
                bondTableBody.innerHTML = `
                        <tr>
                            <td colspan="${totalColumns}" class="col-empty-state">
                                <div class="empty-state">
                                    <i class="fas fa-scroll"></i>
                                    <p>No bonds found. Add a bond or adjust the "Show Matured" filter.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                return;
            }

            bondsToRender.forEach((bond) => {
                // Find the index from the original 'bonds' array to ensure correct editing/deleting
                const originalIndex = bonds.indexOf(bond);

                const row = document.createElement('tr');
                row.className = 'parent-row'; // For responsive logic
                row.dataset.serial = bond.serial;
                row.dataset.index = originalIndex; // Use the original index

                // --- Basic Bond Data ---
                const capital = parseFloat(bond.capital) || 0;
                const annualReturnPercent = parseFloat(bond.return) || 0;
                const settlement = new Date(bond.settlement);
                const maturity = new Date(bond.maturity);

                // --- Time Calculations ---
                let monthsDiff = 0;
                let yearsDiff = 0;
                if (!isNaN(settlement.getTime()) && !isNaN(maturity.getTime()) && maturity > settlement) {
                    monthsDiff = (maturity.getFullYear() - settlement.getFullYear()) * 12 + (maturity.getMonth() - settlement.getMonth());
                    yearsDiff = Math.ceil(monthsDiff / 12);
                }

                // --- Calculated "Expected" Values ---
                const calculatedMonthlyReturn = ((capital * (annualReturnPercent / 100)) / 12) * 0.90; // Apply 10% tax
                const netReturnPercent = annualReturnPercent * 0.90; // Net return after tax
                const expectedTotalReturn = capital * (netReturnPercent / 100) * yearsDiff;

                // --- "Real" Values from Statement ---
                let latestRealMonthlyReturn = 0;
                let realTotalReturn = 0;
                let realPercentageReturn = 0;

                if (bond.serial && parsedData.length > 0) {
                    // Find all credit transactions related to this bond's coupon payments
                    const relatedTransactions = parsedData
                        .filter(t => t.Description.toLowerCase().includes(bond.serial.toLowerCase()) && t.DBCR === 'CR');

                    // Get the latest coupon payment amount
                    if (relatedTransactions.length > 0) {
                        let latestIndex = relatedTransactions.length - 1;
                        latestRealMonthlyReturn = parseFloat(relatedTransactions[latestIndex].Amount) || 0;

                        if (latestIndex >= 1 && relatedTransactions[latestIndex].Amount == bond.capital) {
                            latestIndex -= 1;
                            latestRealMonthlyReturn = parseFloat(relatedTransactions[latestIndex].Amount) || 0;
                        }
                    }

                    // Sum all coupon payments to get total real return
                    const totalRealReturnFromStatement = relatedTransactions.reduce((sum, t) => sum + (parseFloat(t.Amount) || 0), 0);

                    // If the bond has matured, subtract the principal to get the net profit. Otherwise, show total received so far.
                    const isMatured = !isNaN(maturity.getTime()) && new Date() > maturity;
                    realTotalReturn = isMatured ? totalRealReturnFromStatement - capital : totalRealReturnFromStatement;

                    // Calculate the annualized real return percentage
                    if (capital > 0 && yearsDiff > 0) {
                        realPercentageReturn = (realTotalReturn / capital) * 100 / yearsDiff;
                    }
                }

                // --- Build the HTML for the row ---
                row.innerHTML = `
                        <td class="toggle-column column-hidden"><span class="toggle-icon"></span></td>
                        <td>${bond.serial}</td>
                        <td class="money-cell">${formatMoney(capital)}</td>
                        <td>${bond.type}</td>
                        <td class="money-cell">${formatMoney(annualReturnPercent)}%</td>
                        <td class="${settlement <= new Date() ? 'delta-positive' : 'delta-negative'}">${formatDate(bond.settlement)}</td>
                        <td class="${maturity <= new Date() ? 'delta-positive' : 'delta-negative'}">${formatDate(bond.maturity)}</td>
                        <td class="col-number">${monthsDiff}</td>
                        <td class="col-number">${yearsDiff}</td>
                        
                        <!-- Monthly Return (Calculated vs. Real Latest) -->
                        <td class="money-cell dual-value">
                            <span class="${latestRealMonthlyReturn >= calculatedMonthlyReturn ? 'above-expec' : 'below-expec'}">${formatMoney(latestRealMonthlyReturn)}</span>
                            <span class="calc-value">(${formatMoney(calculatedMonthlyReturn)})</span>
                        </td>
                        
                        <!-- Total Return (Calculated vs. Real) -->
                        <td class="money-cell dual-value">
                            <span class="${realTotalReturn >= expectedTotalReturn ? 'above-expec' : 'below-expec'}">${formatMoney(realTotalReturn)}</span>
                            <span class="calc-value">(${formatMoney(expectedTotalReturn)})</span>
                        </td>
                        
                        <!-- Percentage Return (Calculated Net vs. Real Annualized) -->
                        <td class="money-cell dual-value">
                                <span class="${realPercentageReturn >= netReturnPercent ? 'above-expec' : 'below-expec'}">${formatMoney(realPercentageReturn)}%</span>
                                <span class="calc-value">(${formatMoney(netReturnPercent)}%)</span>
                        </td>
                        
                        <!-- Action Buttons -->
                        <td class="col-actions">
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-small edit-bond"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-small delete-bond"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                bondTableBody.appendChild(row);
                // Add the child row for responsive data
                const childRow = document.createElement('tr');
                childRow.className = 'child-row column-hidden';
                childRow.innerHTML = `<td colspan="${totalColumns}"></td>`;
                bondTableBody.appendChild(childRow);
            });

            // FIX: Correctly call the responsive update function from the map
            const updateFn = updateFunctions.get('bond');
            if (updateFn) {
                updateFn();
            }
        }

        function handleBondTableClick(e) {
            const target = e.target;

            if (target.closest('.toggle-icon.visible')) {
                return;
            }
            const button = target.closest('button');
            const row = target.closest('tr.parent-row');

            if (!row) return;

            if (button && button.classList.contains('edit-bond')) {
                const index = parseInt(row.dataset.index);
                editBond(index);
                return;
            }

            if (button && button.classList.contains('delete-bond')) {
                const index = parseInt(row.dataset.index);
                deleteBond(index);
                return;
            }
            if (row.classList.contains('row-is-collapsible') && !e.target.closest('button')) {
                const icon = row.querySelector('.toggle-icon');
                if (icon) {
                    icon.click();
                }
            }

            const serial = row.dataset.serial;
            if (serial) {
                showBondDetails(serial);
            }
        }

        function renderBondComparePage() {
            // Filter bonds based on the "Show Matured" checkbox state
            const shouldShowMatured = showMaturedBonds.checked;
            const bondsToCompare = shouldShowMatured ? [...bonds] : bonds.filter(bond => {
                if (!bond.maturity) return true; // Always show if no maturity date is set
                const maturity = new Date(bond.maturity);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Compare against the start of today
                return isNaN(maturity.getTime()) || maturity >= today;
            });
            bondCompareView.innerHTML = ''; // Clear previous content
            if (bondsToCompare.length === 0) {
                bondCompareView.innerHTML = `<div class="empty-state"><i class="fas fa-search-dollar"></i><p>No bonds to compare. Add some or adjust the "Show Matured" filter.</p></div>`;
                return;
            }
            // 1. Build Controls with the new Dropdown structure
            let controlsHtml = `
                    <div id="bond-compare-controls">
                        <div class="dropdown-container">
                            <button id="bond-visibility-toggle" class="btn btn-secondary dropdown-toggle">
                                <span>Show/Hide Bonds</span>
                            </button>
                            <div id="bond-visibility-menu" class="dropdown-menu">`;
            bondsToCompare.forEach((bond, index) => {
                controlsHtml += `
                        <label>
                            <input type="checkbox" class="visibility-toggle" data-col-index="${index + 1}" checked>
                            <span>${bond.serial}</span>
                        </label>
                    `;
            });
            controlsHtml += `
                            </div>
                        </div>
                    </div>
                `;
            // 2. Build Table (this part remains unchanged)
            let tableHtml = '<div class="table-container" id="bond-compare-table-container"><table id="bondCompareTable">';
            tableHtml += '<thead><tr>';
            tableHtml += '<th>#</th>';
            bondsToCompare.forEach(bond => {
                const maturity = new Date(bond.maturity);
                const isMatured = !isNaN(maturity.getTime()) && new Date() > maturity;
                const colorClass = isMatured ? 'delta-positive' : 'delta-negative';

                tableHtml += `
                        <th>
                            ${bond.serial}
                            <span class="header-maturity ${colorClass}">
                                ${formatDate(bond.maturity).replace(/<b>|<\/b>/g, '')}
                            </span>
                        </th>`;
            });
            tableHtml += '</tr></thead>';
            tableHtml += '<tbody>';
            const bondCouponDetails = bondsToCompare.map(bond => {
                const settlement = new Date(bond.settlement);
                const maturity = new Date(bond.maturity);
                let monthsDiff = 0;
                if (!isNaN(settlement.getTime()) && !isNaN(maturity.getTime()) && maturity > settlement) {
                    monthsDiff = (maturity.getFullYear() - settlement.getFullYear()) * 12 + (maturity.getMonth() - settlement.getMonth());
                }
                const capital = parseFloat(bond.capital) || 0;
                const annualReturnPercent = parseFloat(bond.return) || 0;
                const monthlyCoupon = ((capital * (annualReturnPercent / 100)) / 12) * 0.90;
                return {
                    numCoupons: monthsDiff,
                    amount: monthlyCoupon
                };
            });
            const maxCoupons = Math.max(0, ...bondCouponDetails.map(d => d.numCoupons));
            for (let i = 1; i <= maxCoupons; i++) {
                tableHtml += `<tr><td>${i}</td>`;
                bondCouponDetails.forEach(details => {
                    if (i <= details.numCoupons) {
                        tableHtml += `<td class="money-cell">${formatMoney(details.amount)}</td>`;
                    } else {
                        tableHtml += '<td>-</td>';
                    }
                });
                tableHtml += '</tr>';
            }
            tableHtml += '</tbody></table></div>';
            // 3. Inject into DOM
            bondCompareView.innerHTML = controlsHtml + tableHtml;
            // 4. Attach Listeners
            attachCompareViewListeners();
        }

        function attachCompareViewListeners() {
            const toggleBtn = document.getElementById('bond-visibility-toggle');
            const menu = document.getElementById('bond-visibility-menu');
            if (!toggleBtn || !menu) return;
            const dropdownContainer = toggleBtn.closest('.dropdown-container');
            // 1. Open/Close the dropdown when the button is clicked
            toggleBtn.addEventListener('click', () => {
                menu.classList.toggle('show');
            });
            // 2. Handle checkbox changes to show/hide table columns
            menu.addEventListener('change', (e) => {
                if (e.target.classList.contains('visibility-toggle')) {
                    // The index of the column to toggle (e.g., 2nd, 3rd...)
                    const colToShowHide = parseInt(e.target.dataset.colIndex) + 1;
                    const isChecked = e.target.checked;
                    const table = document.getElementById('bondCompareTable');
                    if (!table) return;
                    // Iterate through all rows (header and body) to toggle the correct cell
                    table.querySelectorAll('tr').forEach(row => {
                        const cell = row.querySelector(`th:nth-child(${colToShowHide}), td:nth-child(${colToShowHide})`);
                        if (cell) {
                            cell.style.display = isChecked ? '' : 'none';
                        }
                    });
                }
            });
            // 3. Close the dropdown when clicking anywhere outside of it
            window.addEventListener('click', (e) => {
                // If the menu is open AND the click was NOT inside the dropdown container
                if (menu.classList.contains('show') && !dropdownContainer.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });
        }

        function showBondDetails(bondSerial) {
            const bond = bonds.find(b => b.serial === bondSerial);
            if (!bond) return;

            summaryDetailTitle.innerHTML = `<i class="fas fa-scroll"></i> Transaction Details for Bond "${bondSerial}"`;

            const detailRecords = parsedData.filter(t =>
                t.Description.toLowerCase().includes(bond.serial.toLowerCase()) && t.DBCR === 'CR'
            );

            summaryDetailBody.innerHTML = '';

            if (detailRecords.length === 0) {
                summaryDetailBody.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><p>No return transactions found in the statement for this bond.</p></div>`;
            } else {
                let tableHtml = `<div class="table-container"><table><thead><tr><th>Date</th><th>Description</th><th class="col-number">Amount</th><th></th></tr></thead><tbody>`;

                let totalCredited = 0;
                detailRecords.forEach(row => {
                    totalCredited += parseFloat(row.Amount) || 0;

                    tableHtml += `
                            <tr>
                                <td>${formatDate(row.Date)}</td>
                                <td class="description-column">${row.Description}</td>
                                <td class="money-cell">${formatMoney(row.Amount)}</td>
                                <td>${row.DBCR}</td>
                            </tr>
                        `;
                });

                tableHtml += `
                        <tr class="summary-details-total-row">
                           <td colspan="2" class="col-number">Total Credited:</td>
                           <td class="money-cell">${formatMoney(totalCredited)}</td>
                           <td></td>
                        </tr>
                    `;

                tableHtml += `</tbody></table></div>`;
                summaryDetailBody.innerHTML = tableHtml;
            }

            summaryDetailModal.classList.add('show');
        }

        function addBond() {
            const serial = bondSerial.value.trim();
            const capital = parseFloat(bondCapital.value);

            if (!serial) {
                showNotification('Please enter a bond serial', 'danger');
                return;
            }

            if (isNaN(capital) || capital <= 0) {
                showNotification('Please enter a valid capital amount', 'danger');
                return;
            }

            if (bonds.some(b => b.serial.toLowerCase() === serial.toLowerCase())) {
                showNotification('A bond with this serial already exists', 'warning');
                return;
            }

            const newBond = {
                serial: serial,
                type: bondType.value.trim(),
                capital: capital,
                return: parseFloat(bondReturn.value) || 0,
                settlement: bondSettlement.value,
                maturity: bondMaturity.value
            };

            bonds.push(newBond);
            resetBondForm();
            renderBonds();
            showNotification(`Bond "${serial}" added successfully!`, 'success');

            if (!isBondFormCollapsed) {
                bondFormHeader.click();
            }
        }

        function editBond(index) {
            if (index < 0 || index >= bonds.length) return;

            const bond = bonds[index];
            bondSerial.value = bond.serial;
            bondType.value = bond.type;
            bondCapital.value = bond.capital;
            bondReturn.value = bond.return;
            bondSettlement.value = bond.settlement;
            bondMaturity.value = bond.maturity;

            editingBondIndex = index;

            addBondBtn.classList.add('d-none');
            updateBondBtn.classList.remove('d-none');
            cancelBondEditBtn.classList.remove('d-none');
            clearBondFormBtn.classList.add('d-none');

            if (isBondFormCollapsed) {
                bondFormHeader.click();
            }
        }

        function updateBond() {
            if (editingBondIndex < 0 || editingBondIndex >= bonds.length) return;

            const serial = bondSerial.value.trim();
            const capital = parseFloat(bondCapital.value);

            if (!serial) {
                showNotification('Please enter a bond serial', 'danger');
                return;
            }

            if (isNaN(capital) || capital <= 0) {
                showNotification('Please enter a valid capital amount', 'danger');
                return;
            }

            const existingIndex = bonds.findIndex((b, i) =>
                b.serial.toLowerCase() === serial.toLowerCase() && i !== editingBondIndex);

            if (existingIndex !== -1) {
                showNotification('Another bond already has this serial', 'warning');
                return;
            }

            bonds[editingBondIndex] = {
                serial: serial,
                type: bondType.value.trim(),
                capital: capital,
                return: parseFloat(bondReturn.value) || 0,
                settlement: bondSettlement.value,
                maturity: bondMaturity.value
            };

            resetBondForm();
            renderBonds();
            showNotification(`Bond "${serial}" updated successfully!`, 'success');
        }

        function deleteBond(index) {
            if (index < 0 || index >= bonds.length) return;

            const bondName = bonds[index].serial;
            if (confirm(`Are you sure you want to delete the bond "${bondName}"?`)) {
                bonds.splice(index, 1);
                renderBonds();
                showNotification(`Bond "${bondName}" deleted successfully!`, 'success');

                if (editingBondIndex === index) {
                    resetBondForm();
                } else if (editingBondIndex > index) {
                    editingBondIndex--;
                }
            }
        }

        function cancelBondEdit() {
            resetBondForm();
        }

        function resetBondForm() {
            bondSerial.value = '';
            bondType.value = '';
            bondCapital.value = '';
            bondReturn.value = '';
            bondSettlement.value = '';
            bondMaturity.value = '';
            editingBondIndex = -1;
            addBondBtn.classList.remove('d-none');
            updateBondBtn.classList.add('d-none');
            cancelBondEditBtn.classList.add('d-none');
            clearBondFormBtn.classList.remove('d-none');
        }

        function populateSummaryFilters() {
            renderSummaryTable([]);
            summaryYear.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Select Year";
            summaryYear.appendChild(defaultOption);

            if (parsedData.length === 0) {
                summaryYear.disabled = true;
                summaryMonth.disabled = true;
                generateSummaryBtn.disabled = true;
                return;
            }

            summaryYear.disabled = false;
            summaryMonth.disabled = false;
            generateSummaryBtn.disabled = false;

            const years = [...new Set(parsedData.map(row => new Date(row.Date.split('/').reverse().join('-')).getFullYear()))];
            years.sort((a, b) => b - a);

            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                summaryYear.appendChild(option);
            });

            if (years.length > 0) {
                summaryYear.value = years[0];
            }
        }

        function generateSummary() {
            const selectedYear = parseInt(summaryYear.value);
            const selectedMonth = parseInt(summaryMonth.value);

            if (isNaN(selectedYear)) {
                renderSummaryTable([]);
                return;
            }

            const summaryDataMap = new Map();

            categories.forEach(cat => {
                summaryDataMap.set(cat.name, {
                    category: cat.name,
                    monthCr: 0,
                    monthDb: 0,
                    monthTotal: 0,
                    yearCr: 0,
                    yearDb: 0,
                    yearTotal: 0,
                    rank: cat.rank
                });
            });

            summaryDataMap.set('Uncategorized', {
                category: 'Uncategorized',
                monthCr: 0,
                monthDb: 0,
                monthTotal: 0,
                yearCr: 0,
                yearDb: 0,
                yearTotal: 0,
                rank: Number.MAX_SAFE_INTEGER
            });

            const yearRecords = parsedData.filter(row => new Date(row.Date.split('/').reverse().join('-')).getFullYear() === selectedYear);
            const sortedCategories = [...categories].sort((a, b) => a.rank - b.rank);

            yearRecords.forEach(row => {
                const recordDate = new Date(row.Date.split('/').reverse().join('-'));
                const recordMonth = recordDate.getMonth();
                const amount = parseFloat(row.Amount) || 0;
                const description = row.Description.toLowerCase();
                let wasCategorized = false;

                for (const cat of sortedCategories) {
                    // We create a flag for the inner loop to see if this specific category matched.
                    let categoryMatched = false;
                    for (const keyword of cat.keywords) {
                        if (description.includes(keyword.toLowerCase())) {
                            const assignedCategoryName = cat.name;
                            const currentSummary = summaryDataMap.get(assignedCategoryName);

                            if (row.DBCR === 'CR') currentSummary.yearCr += amount;
                            else currentSummary.yearDb += amount;

                            if (selectedMonth === -1 || recordMonth === selectedMonth) {
                                if (row.DBCR === 'CR') currentSummary.monthCr += amount;
                                else currentSummary.monthDb += amount;
                            }

                            // Set both flags to true
                            wasCategorized = true;
                            categoryMatched = true;
                            // We break from the *inner* keyword loop, because we only need to add the amount
                            // to this category ONCE, even if it matches multiple keywords in the same category.
                            break;
                        }
                    }
                }

                if (!wasCategorized) {
                    const uncategorizedSummary = summaryDataMap.get('Uncategorized');

                    if (row.DBCR === 'CR') uncategorizedSummary.yearCr += amount;
                    else uncategorizedSummary.yearDb += amount;

                    if (selectedMonth === -1 || recordMonth === selectedMonth) {
                        if (row.DBCR === 'CR') uncategorizedSummary.monthCr += amount;
                        else uncategorizedSummary.monthDb += amount;
                    }
                }
            });
            const finalSummaryData = [];
            summaryDataMap.forEach(values => {
                values.monthTotal = values.monthCr - values.monthDb;
                values.yearTotal = values.yearCr - values.yearDb;

                if (values.yearCr > 0 || values.yearDb > 0) {
                    finalSummaryData.push(values);
                }
            });
            finalSummaryData.sort((a, b) => a.rank - b.rank);
            renderSummaryTable(finalSummaryData);
            // FIX: Correctly call the responsive update function from the map
            const updateFn = updateFunctions.get('summary');
            if (updateFn) {
                updateFn();
            }
        }

        function renderSummaryTable(data) {
            const table = document.getElementById('summaryTable');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            const totalColumns = document.querySelectorAll('#summaryTable thead th').length;
            if (data.length === 0) {
                if (!summaryResultContainer.querySelector('.empty-state')) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.innerHTML = '<i class="fas fa-search-dollar"></i><p>No activity found for the selected criteria.</p>';
                    summaryResultContainer.appendChild(emptyState);
                }
                table.style.display = 'none';
                return;
            }

            const emptyState = summaryResultContainer.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            table.style.display = 'table';

            data.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'parent-row';
                tr.dataset.categoryName = item.category;
                tr.addEventListener('click', (e) => {
                    // Ignore click if it's on the toggle icon or its container cell
                    if (e.target.closest('.toggle-column') || e.target.classList.contains('toggle-icon')) {
                        return;
                    }
                    showSummaryDetails(item.category);
                });

                tr.innerHTML = `
                        <td class="toggle-column column-hidden"><span class="toggle-icon"></span></td>
                        <td>${idx + 1}</td>
                        <td>${item.category}</td>
                        <td class="money-cell">${formatMoney(item.monthCr)}</td>
                        <td class="money-cell">${formatMoney(item.monthDb)}</td>
                        <td class="money-cell ${item.monthTotal >= 0 ? 'delta-positive' : 'delta-negative'}">${formatMoney(item.monthTotal)}</td>
                        <td class="money-cell">${formatMoney(item.yearCr)}</td>
                        <td class="money-cell">${formatMoney(item.yearDb)}</td>
                        <td class="money-cell ${item.yearTotal >= 0 ? 'delta-positive' : 'delta-negative'}">${formatMoney(item.yearTotal)}</td>
                    `;
                tbody.appendChild(tr);
                const childRow = document.createElement('tr');
                childRow.className = 'child-row column-hidden';
                childRow.innerHTML = `<td colspan="${totalColumns}"></td>`;
                tbody.appendChild(childRow);
            });
        }

        function showSummaryDetails(categoryName) {
            const selectedYear = parseInt(summaryYear.value);
            const selectedMonth = parseInt(summaryMonth.value);
            const monthName = selectedMonth === -1 ? "All Year" : summaryMonth.options[summaryMonth.selectedIndex].text;

            summaryDetailTitle.innerHTML = `<i class="fas fa-list-ul"></i> Details for "${categoryName}" in ${monthName} ${selectedYear}`;

            // Get all records for the selected time period first.
            let relevantRecords = parsedData.filter(row => {
                const rowDate = new Date(row.Date.split('/').reverse().join('-'));
                const isYearMatch = rowDate.getFullYear() === selectedYear;
                const isMonthMatch = (selectedMonth === -1) || (rowDate.getMonth() === selectedMonth);
                return isYearMatch && isMonthMatch;
            });

            let detailRecords = [];

            if (categoryName === 'Uncategorized') {
                // The logic for Uncategorized is different. It finds records that don't match ANY keyword from ANY category.
                // This logic is still correct.
                detailRecords = relevantRecords.filter(row => {
                    const description = row.Description.toLowerCase();
                    return !categories.some(cat =>
                        cat.keywords.some(kw => description.includes(kw.toLowerCase()))
                    );
                });
            } else {
                // --- THIS IS THE UPDATED LOGIC FOR ALL OTHER CATEGORIES ---
                
                // 1. Find the specific category the user clicked on.
                const category = categories.find(cat => cat.name === categoryName);
                if (!category) return; // Exit if the category isn't found

                // 2. Get the keywords for just that category.
                const keywords = category.keywords.map(k => k.toLowerCase());

                // 3. Filter the records. A record is included if its description contains ANY of this category's keywords.
                detailRecords = relevantRecords.filter(row => {
                    const description = row.Description.toLowerCase();
                    return keywords.some(kw => description.includes(kw));
                });
            }

            summaryDetailBody.innerHTML = '';

            if (detailRecords.length === 0) {
                summaryDetailBody.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><p>No transactions found for this category in the selected period.</p></div>`;
            } else {
                let tableHtml = `<div class="table-container"><table><thead><tr><th>Date</th><th>Description</th><th class="col-number">Amount</th><th></th></tr></thead><tbody>`;

                detailRecords.forEach(row => {
                    tableHtml += `
                            <tr>
                                <td>${formatDate(row.Date)}</td>
                                <td class="description-column">${row.Description}</td>
                                <td class="money-cell">${formatMoney(row.Amount)}</td>
                                <td>${row.DBCR}</td>
                            </tr>
                        `;
                });

                tableHtml += `</tbody></table></div>`;
                summaryDetailBody.innerHTML = tableHtml;
            }

            summaryDetailModal.classList.add('show');
        }

        function initializeResponsiveTable(selector) {
            const containerOrTable = $(selector);
            let headers = [];
            // The function that performs the actual update. We will return this.
            const updateResponsiveness = () => {
                // Find tables within the selector. This handles the "All Data" tab which has multiple tables.
                const tables = containerOrTable.is('table') ? containerOrTable : containerOrTable.find('table');
                if (!tables.length) return;
                // Initialize headers only once from the first table found
                if (headers.length === 0) {
                    tables.first().find('thead th').each(function(index) {
                        headers.push({
                            index: index,
                            priority: $(this).data('priority'),
                            text: $(this).text(),
                            visible: true
                        });
                    });
                }
                if (headers.length === 0) return; // Exit if no headers found
                tables.each(function() {
                    const table = $(this);

                    setTimeout(() => {
                        if (table.width() === 0) return; // Don't process hidden tables

                        const container = table.parent(); // The immediate parent is the scrollable container
                        const containerWidth = container.width();
                        const totalColumns = headers.length;
                        // Reset table state
                        table.find('th, td').removeClass('column-hidden');
                        table.find('.parent-row').removeClass('row-is-collapsible');
                        table.find('.toggle-icon').removeClass('visible').empty();
                        table.find('.child-row').addClass('column-hidden').find('td').empty();
                        headers.forEach(h => h.visible = true);
                        let hasHiddenColumns = false;
                        const hideableColumns = headers.filter(h => h.priority).sort((a, b) => b.priority - a.priority);
                        for (const columnToHide of hideableColumns) {
                            if (table.width() > containerWidth) {
                                table.find('tr').each(function() {
                                    $(this).find('th, td').eq(columnToHide.index).addClass('column-hidden');
                                });
                                columnToHide.visible = false;
                                hasHiddenColumns = true;
                            } else {
                                break;
                            }
                        }
                        if (hasHiddenColumns) {
                            table.find('.toggle-column').removeClass('column-hidden');
                            table.find('tbody tr.parent-row').each(function() {
                                const parentRow = $(this);
                                const childRow = parentRow.next('tr.child-row');
                                const childRowTd = childRow.find('td').attr('colspan', totalColumns);
                                let detailsHtml = '<div class="details-container"><table class="child-details-table">';
                                let rowHasHiddenData = false;
                                headers.forEach(header => {
                                    if (!header.visible && header.priority) {
                                        rowHasHiddenData = true;
                                        const cellValue = parentRow.find('td').eq(header.index).html();
                                        detailsHtml += `<tr><td>${header.text}</td><td>${cellValue}</td></tr>`;
                                    }
                                });
                                detailsHtml += '</table></div>';

                                if (rowHasHiddenData) {
                                    childRowTd.html(detailsHtml);
                                    parentRow.addClass('row-is-collapsible');
                                    parentRow.find('.toggle-icon').addClass('visible').text('+');
                                }
                            });
                        } else {
                            table.find('.toggle-column').addClass('column-hidden');
                        }
                    }, 0);
                });
            };
            // Attach the click handler using event delegation on the main container
            containerOrTable.on('click', '.toggle-icon.visible', function(e) {
                e.stopPropagation();
                const parentRow = $(this).closest('.parent-row');
                const childRow = parentRow.next('tr.child-row');
                childRow.toggleClass('column-hidden');
                $(this).text($(this).text() === '+' ? '−' : '+');
            });
            // Initial run
            updateResponsiveness();
            // Return the update function so it can be called externally (e.g., after rendering new data)
            return updateResponsiveness;
        }
    });
</script>

</body>
</html>
